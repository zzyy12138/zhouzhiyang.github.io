<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
    
  
  <link href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






  

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="å¹¶å‘ï¼Œ I/Oå¤šè·¯å¤ç”¨" />





  <link rel="alternate" href="/atom.xml" title="EZLippi-æµ®ç”Ÿå¿—" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="Epollå¯æ˜¯å½“å‰åœ¨Linuxä¸‹å¼€å‘å¤§è§„æ¨¡å¹¶å‘ç½‘ç»œç¨‹åºçš„çƒ­é—¨äººé€‰ï¼ŒEpoll åœ¨Linux2.6å†…æ ¸ä¸­æ­£å¼å¼•å…¥ï¼Œå’Œselectç›¸ä¼¼ï¼Œå…¶å®éƒ½I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯è€Œå·²ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆç¥ç§˜çš„ã€‚
å…¶å®åœ¨Linuxä¸‹è®¾è®¡å¹¶å‘ç½‘ç»œç¨‹åºï¼Œå‘æ¥ä¸ç¼ºå°‘æ–¹æ³•ï¼Œæ¯”å¦‚å…¸å‹çš„Apacheæ¨¡å‹ï¼ˆProcess Per Connectionï¼Œç®€ç§°PPCï¼‰ï¼ŒTPCï¼ˆThread Per Connectionï¼‰æ¨¡å‹ï¼Œä»¥åŠselectæ¨¡å‹">
<meta property="og:type" content="article">
<meta property="og:title" content="å¤„ç†å¹¶å‘ä¹‹ä¸€ï¼šLINUX Epollæœºåˆ¶ä»‹ç»">
<meta property="og:url" content="http://www.ezlippi.com/blog/2014/08/linux-epoll.html">
<meta property="og:site_name" content="EZLippi-æµ®ç”Ÿå¿—">
<meta property="og:description" content="Epollå¯æ˜¯å½“å‰åœ¨Linuxä¸‹å¼€å‘å¤§è§„æ¨¡å¹¶å‘ç½‘ç»œç¨‹åºçš„çƒ­é—¨äººé€‰ï¼ŒEpoll åœ¨Linux2.6å†…æ ¸ä¸­æ­£å¼å¼•å…¥ï¼Œå’Œselectç›¸ä¼¼ï¼Œå…¶å®éƒ½I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯è€Œå·²ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆç¥ç§˜çš„ã€‚
å…¶å®åœ¨Linuxä¸‹è®¾è®¡å¹¶å‘ç½‘ç»œç¨‹åºï¼Œå‘æ¥ä¸ç¼ºå°‘æ–¹æ³•ï¼Œæ¯”å¦‚å…¸å‹çš„Apacheæ¨¡å‹ï¼ˆProcess Per Connectionï¼Œç®€ç§°PPCï¼‰ï¼ŒTPCï¼ˆThread Per Connectionï¼‰æ¨¡å‹ï¼Œä»¥åŠselectæ¨¡å‹">
<meta property="og:updated_time" content="2016-03-18T08:43:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="å¤„ç†å¹¶å‘ä¹‹ä¸€ï¼šLINUX Epollæœºåˆ¶ä»‹ç»">
<meta name="twitter:description" content="Epollå¯æ˜¯å½“å‰åœ¨Linuxä¸‹å¼€å‘å¤§è§„æ¨¡å¹¶å‘ç½‘ç»œç¨‹åºçš„çƒ­é—¨äººé€‰ï¼ŒEpoll åœ¨Linux2.6å†…æ ¸ä¸­æ­£å¼å¼•å…¥ï¼Œå’Œselectç›¸ä¼¼ï¼Œå…¶å®éƒ½I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯è€Œå·²ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆç¥ç§˜çš„ã€‚
å…¶å®åœ¨Linuxä¸‹è®¾è®¡å¹¶å‘ç½‘ç»œç¨‹åºï¼Œå‘æ¥ä¸ç¼ºå°‘æ–¹æ³•ï¼Œæ¯”å¦‚å…¸å‹çš„Apacheæ¨¡å‹ï¼ˆProcess Per Connectionï¼Œç®€ç§°PPCï¼‰ï¼ŒTPCï¼ˆThread Per Connectionï¼‰æ¨¡å‹ï¼Œä»¥åŠselectæ¨¡å‹">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 'undefined',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.ezlippi.com/blog/2014/08/linux-epoll.html"/>





<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*è¿›åº¦æ¡é¢œè‰²*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*é˜´å½±é¢œè‰²*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*ä¸Šè¾¹æ¡†é¢œè‰²*/
        border-left-color: #1E92FB;    /*å·¦è¾¹æ¡†é¢œè‰²*/
    }
</style>

  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "d1b06a58"
    });
  daovoice('update');
  </script>


  <title> å¤„ç†å¹¶å‘ä¹‹ä¸€ï¼šLINUX Epollæœºåˆ¶ä»‹ç» | EZLippi-æµ®ç”Ÿå¿— </title>
</head>

  	 <!-- custom analytics part create by xiamo -->
<script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
<script>AV.initialize("kJ2sJuSJeByLioULSXrJ5CSq-9Nh9j0Va", "uBWeNxCbFEWsOVDTmAInrDq3");</script>
<script>
function showTime(Counter) {
	var query = new AV.Query(Counter);
	$(".leancloud_visitors").each(function() {
		var url = $(this).attr("id").trim();
		query.equalTo("url", url);
		query.find({
			success: function(results) {
				if (results.length == 0) {
					var content = $(document.getElementById(url)).text() + ': 0';
					$(document.getElementById(url)).text(content);
					return;
				}
				for (var i = 0; i < results.length; i++) {
					var object = results[i];
					var content = $(document.getElementById(url)).text() + ': ' + object.get('time');
					$(document.getElementById(url)).text(content);
				}
			},
			error: function(object, error) {
				console.log("Error: " + error.code + " " + error.message);
			}
		});

	});
}

function addCount(Counter) {
	var Counter = AV.Object.extend("Counter");
	url = $(".leancloud_visitors").attr('id').trim();
	title = $(".leancloud_visitors").attr('data-flag-title').trim();
	var query = new AV.Query(Counter);
	query.equalTo("url", url);
	query.find({
		success: function(results) {
			if (results.length > 0) {
				var counter = results[0];
				counter.fetchWhenSave(true);
				counter.increment("time");
				counter.save(null, {
					success: function(counter) {
						var content = $(document.getElementById(url)).text() + ': ' + counter.get('time');
						$(document.getElementById(url)).text(content);
					},
					error: function(counter, error) {
						console.log('Failed to save Visitor num, with error message: ' + error.message);
					}
				});
			} else {
				var newcounter = new Counter();
				newcounter.set("title", title);
				newcounter.set("url", url);
				newcounter.set("time", 1);
				newcounter.save(null, {
					success: function(newcounter) {
					    console.log("newcounter.get('time')="+newcounter.get('time'));
						var content = $(document.getElementById(url)).text() + ': ' + newcounter.get('time');
						$(document.getElementById(url)).text(content);
					},
					error: function(newcounter, error) {
						console.log('Failed to create');
					}
				});
			}
		},
		error: function(error) {
			console.log('Error:' + error.code + " " + error.message);
		}
	});
}
$(function() {
	var Counter = AV.Object.extend("Counter");
	if ($('.leancloud_visitors').length == 1) {
		addCount(Counter);
	} else if ($('.post-title-link').length > 1) {
		showTime(Counter);
	}
});
</script>
  
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?340874ba9357cbe81570aa4ac1185941";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta custom-logo">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">EZLippi-æµ®ç”Ÿå¿—</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <h1 class="site-subtitle" itemprop="description"></h1>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            å…³äº
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            æœç´¢
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.ezlippi.com/blog/2014/08/linux-epoll.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="EZLippi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="EZLippi-æµ®ç”Ÿå¿—">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="EZLippi-æµ®ç”Ÿå¿—" src="/images/avatar.jpg">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                å¤„ç†å¹¶å‘ä¹‹ä¸€ï¼šLINUX Epollæœºåˆ¶ä»‹ç»
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-08-23T00:00:00+08:00">
                2014-08-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/c/" itemprop="url" rel="index">
                    <span itemprop="name">c</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
		  
			 
          
          
             <span id="/blog/2014/08/linux-epoll.html" class="leancloud_visitors" data-flag-title="å¤„ç†å¹¶å‘ä¹‹ä¸€ï¼šLINUX Epollæœºåˆ¶ä»‹ç»">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">çƒ­åº¦ </span>
               
                 <span class="leancloud-visitors-count"></span>
				 <span>â„ƒ</span>
             </span>
          
		   
          

		  
            <div class="post-wordcount">
              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  4,504
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  20
                </span>
              
            </div>
          
		  
          
 
        


        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Epollå¯æ˜¯å½“å‰åœ¨Linuxä¸‹å¼€å‘å¤§è§„æ¨¡å¹¶å‘ç½‘ç»œç¨‹åºçš„çƒ­é—¨äººé€‰ï¼ŒEpoll åœ¨Linux2.6å†…æ ¸ä¸­æ­£å¼å¼•å…¥ï¼Œå’Œselectç›¸ä¼¼ï¼Œå…¶å®éƒ½I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯è€Œå·²ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆç¥ç§˜çš„ã€‚</p>
<p>å…¶å®åœ¨Linuxä¸‹è®¾è®¡å¹¶å‘ç½‘ç»œç¨‹åºï¼Œå‘æ¥ä¸ç¼ºå°‘æ–¹æ³•ï¼Œæ¯”å¦‚å…¸å‹çš„Apacheæ¨¡å‹ï¼ˆProcess Per Connectionï¼Œç®€ç§°PPCï¼‰ï¼ŒTPCï¼ˆThread Per Connectionï¼‰æ¨¡å‹ï¼Œä»¥åŠselectæ¨¡å‹å’Œpollæ¨¡å‹ï¼Œé‚£ä¸ºä½•è¿˜è¦å†å¼•å…¥Epollè¿™ä¸ªä¸œä¸œå‘¢ï¼Ÿé‚£è¿˜æ˜¯æœ‰å¾—è¯´è¯´çš„â€¦<br><a id="more"></a></p>
<h2 id="2-å¸¸ç”¨æ¨¡å‹çš„ç¼ºç‚¹"><a href="#2-å¸¸ç”¨æ¨¡å‹çš„ç¼ºç‚¹" class="headerlink" title="2. å¸¸ç”¨æ¨¡å‹çš„ç¼ºç‚¹"></a>2. å¸¸ç”¨æ¨¡å‹çš„ç¼ºç‚¹</h2><p>å¦‚æœä¸æ‘†å‡ºæ¥å…¶ä»–æ¨¡å‹çš„ç¼ºç‚¹ï¼Œæ€ä¹ˆèƒ½å¯¹æ¯”å‡ºEpollçš„ä¼˜ç‚¹å‘¢ã€‚</p>
<h3 id="2-1-PPC-TPCæ¨¡å‹"><a href="#2-1-PPC-TPCæ¨¡å‹" class="headerlink" title="2.1 PPC/TPCæ¨¡å‹"></a>2.1 PPC/TPCæ¨¡å‹</h3><p>è¿™ä¸¤ç§æ¨¡å‹æ€æƒ³ç±»ä¼¼ï¼Œå°±æ˜¯è®©æ¯ä¸€ä¸ªåˆ°æ¥çš„è¿æ¥ä¸€è¾¹è‡ªå·±åšäº‹å»ï¼Œåˆ«å†æ¥çƒ¦æˆ‘ã€‚åªæ˜¯PPCæ˜¯ä¸ºå®ƒå¼€äº†ä¸€ä¸ªè¿›ç¨‹ï¼Œè€ŒTPCå¼€äº†ä¸€ä¸ªçº¿ç¨‹ã€‚å¯æ˜¯åˆ«çƒ¦æˆ‘æ˜¯æœ‰ä»£ä»·çš„ï¼Œå®ƒè¦æ—¶é—´å’Œç©ºé—´å•Šï¼Œè¿æ¥å¤šäº†ä¹‹åï¼Œé‚£ä¹ˆå¤šçš„è¿›ç¨‹/çº¿ç¨‹åˆ‡æ¢ï¼Œè¿™å¼€é”€å°±ä¸Šæ¥äº†ï¼›å› æ­¤è¿™ç±»æ¨¡å‹èƒ½æ¥å—çš„æœ€å¤§è¿æ¥æ•°éƒ½ä¸ä¼šé«˜ï¼Œä¸€èˆ¬åœ¨å‡ ç™¾ä¸ªå·¦å³ã€‚</p>
<h3 id="2-2-selectæ¨¡å‹"><a href="#2-2-selectæ¨¡å‹" class="headerlink" title="2.2 selectæ¨¡å‹"></a>2.2 selectæ¨¡å‹</h3><ol>
<li><p>æœ€å¤§å¹¶å‘æ•°é™åˆ¶ï¼Œå› ä¸ºä¸€ä¸ªè¿›ç¨‹æ‰€æ‰“å¼€çš„FDï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰æ˜¯æœ‰é™åˆ¶çš„ï¼Œç”±FD_SETSIZEè®¾ç½®ï¼Œé»˜è®¤å€¼æ˜¯1024/2048ï¼Œå› æ­¤Selectæ¨¡å‹çš„æœ€å¤§å¹¶å‘æ•°å°±è¢«ç›¸åº”é™åˆ¶äº†ã€‚è‡ªå·±æ”¹æ”¹è¿™ä¸ªFD_SETSIZEï¼Ÿæƒ³æ³•è™½å¥½ï¼Œå¯æ˜¯å…ˆçœ‹çœ‹ä¸‹é¢å§â€¦</p>
</li>
<li><p>æ•ˆç‡é—®é¢˜ï¼Œselectæ¯æ¬¡è°ƒç”¨éƒ½ä¼šçº¿æ€§æ‰«æå…¨éƒ¨çš„FDé›†åˆï¼Œè¿™æ ·æ•ˆç‡å°±ä¼šå‘ˆç°çº¿æ€§ä¸‹é™ï¼ŒæŠŠFD_SETSIZEæ”¹å¤§çš„åæœå°±æ˜¯ï¼Œå¤§å®¶éƒ½æ…¢æ…¢æ¥ï¼Œä»€ä¹ˆï¼Ÿéƒ½è¶…æ—¶äº†ï¼Ÿï¼Ÿï¼ï¼</p>
</li>
<li><p>å†…æ ¸/ç”¨æˆ·ç©ºé—´ å†…å­˜æ‹·è´é—®é¢˜ï¼Œå¦‚ä½•è®©å†…æ ¸æŠŠFDæ¶ˆæ¯é€šçŸ¥ç»™ç”¨æˆ·ç©ºé—´å‘¢ï¼Ÿåœ¨è¿™ä¸ªé—®é¢˜ä¸Šselecté‡‡å–äº†å†…å­˜æ‹·è´æ–¹æ³•ã€‚</p>
</li>
</ol>
<h3 id="2-3-pollæ¨¡å‹"><a href="#2-3-pollæ¨¡å‹" class="headerlink" title="2.3 pollæ¨¡å‹"></a>2.3 pollæ¨¡å‹</h3><p>åŸºæœ¬ä¸Šæ•ˆç‡å’Œselectæ˜¯ç›¸åŒçš„ï¼Œselectç¼ºç‚¹çš„2å’Œ3å®ƒéƒ½æ²¡æœ‰æ”¹æ‰ã€‚</p>
<h2 id="3-Epollçš„æå‡"><a href="#3-Epollçš„æå‡" class="headerlink" title="3.Epollçš„æå‡"></a>3.Epollçš„æå‡</h2><p>æŠŠå…¶ä»–æ¨¡å‹é€ä¸ªæ‰¹åˆ¤äº†ä¸€ä¸‹ï¼Œå†æ¥çœ‹çœ‹Epollçš„æ”¹è¿›ä¹‹å¤„å§ï¼Œå…¶å®æŠŠselectçš„ç¼ºç‚¹åè¿‡æ¥é‚£å°±æ˜¯Epollçš„ä¼˜ç‚¹äº†ã€‚</p>
<p>3.1. Epollæ²¡æœ‰æœ€å¤§å¹¶å‘è¿æ¥çš„é™åˆ¶ï¼Œä¸Šé™æ˜¯æœ€å¤§å¯ä»¥æ‰“å¼€æ–‡ä»¶çš„æ•°ç›®ï¼Œè¿™ä¸ªæ•°å­—ä¸€èˆ¬è¿œå¤§äº2048, ä¸€èˆ¬æ¥è¯´è¿™ä¸ªæ•°ç›®å’Œç³»ç»Ÿå†…å­˜å…³ç³»å¾ˆå¤§ï¼Œå…·ä½“æ•°ç›®å¯ä»¥cat /proc/sys/fs/file-maxå¯Ÿçœ‹ã€‚</p>
<p>3.2. æ•ˆç‡æå‡ï¼ŒEpollæœ€å¤§çš„ä¼˜ç‚¹å°±åœ¨äºå®ƒåªç®¡ä½ â€œæ´»è·ƒâ€çš„è¿æ¥ï¼Œè€Œè·Ÿè¿æ¥æ€»æ•°æ— å…³ï¼Œå› æ­¤åœ¨å®é™…çš„ç½‘ç»œç¯å¢ƒä¸­ï¼ŒEpollçš„æ•ˆç‡å°±ä¼šè¿œè¿œé«˜äºselectå’Œpollã€‚</p>
<p>3.3. å†…å­˜æ‹·è´ï¼ŒEpollåœ¨è¿™ç‚¹ä¸Šä½¿ç”¨äº†â€œå…±äº«å†…å­˜â€ï¼Œè¿™ä¸ªå†…å­˜æ‹·è´ä¹Ÿçœç•¥äº†ã€‚</p>
<h2 id="4-Epollä¸ºä»€ä¹ˆé«˜æ•ˆ"><a href="#4-Epollä¸ºä»€ä¹ˆé«˜æ•ˆ" class="headerlink" title="4. Epollä¸ºä»€ä¹ˆé«˜æ•ˆ"></a>4. Epollä¸ºä»€ä¹ˆé«˜æ•ˆ</h2><p>Epollçš„é«˜æ•ˆå’Œå…¶æ•°æ®ç»“æ„çš„è®¾è®¡æ˜¯å¯†ä¸å¯åˆ†çš„ï¼Œè¿™ä¸ªä¸‹é¢å°±ä¼šæåˆ°ã€‚</p>
<p>é¦–å…ˆå›å¿†ä¸€ä¸‹selectæ¨¡å‹ï¼Œå½“æœ‰I/Oäº‹ä»¶åˆ°æ¥æ—¶ï¼Œselecté€šçŸ¥åº”ç”¨ç¨‹åºæœ‰äº‹ä»¶åˆ°äº†å¿«å»å¤„ç†ï¼Œè€Œåº”ç”¨ç¨‹åºå¿…é¡»è½®è¯¢æ‰€æœ‰çš„FDé›†åˆï¼Œæµ‹è¯•æ¯ä¸ªFDæ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œå¹¶å¤„ç†äº‹ä»¶ï¼›ä»£ç åƒä¸‹é¢è¿™æ ·ï¼š</p>
<pre><code>int res = select(maxfd+1, &amp;readfds, NULL, NULL, 120);
if(res &gt; 0)

{
    for(int i = 0; i &lt; MAX_CONNECTION; i++)
    {
        if(FD_ISSET(allConnection[i],&amp;readfds))
        {
            handleEvent(allConnection[i]);
        }
    }
}
// if(res == 0) handle timeout, res &lt; 0 handle error
</code></pre><p>Epollä¸ä»…ä¼šå‘Šè¯‰åº”ç”¨ç¨‹åºæœ‰I/0äº‹ä»¶åˆ°æ¥ï¼Œè¿˜ä¼šå‘Šè¯‰åº”ç”¨ç¨‹åºç›¸å…³çš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯æ˜¯åº”ç”¨ç¨‹åºå¡«å……çš„ï¼Œå› æ­¤æ ¹æ®è¿™äº›ä¿¡æ¯åº”ç”¨ç¨‹åºå°±èƒ½ç›´æ¥å®šä½åˆ°äº‹ä»¶ï¼Œè€Œä¸å¿…éå†æ•´ä¸ªFDé›†åˆã€‚</p>
<pre><code>intres = epoll_wait(epfd, events, 20, 120);

for(int i = 0; i &lt; res;i++)
{
    handleEvent(events[n]);
}
</code></pre><h2 id="5-Epollå…³é”®æ•°æ®ç»“æ„"><a href="#5-Epollå…³é”®æ•°æ®ç»“æ„" class="headerlink" title="5. Epollå…³é”®æ•°æ®ç»“æ„"></a>5. Epollå…³é”®æ•°æ®ç»“æ„</h2><p>å‰é¢æåˆ°Epollé€Ÿåº¦å¿«å’Œå…¶æ•°æ®ç»“æ„å¯†ä¸å¯åˆ†ï¼Œå…¶å…³é”®æ•°æ®ç»“æ„å°±æ˜¯ï¼š</p>
<pre><code>struct epoll_event {

    __uint32_t events;      // Epoll events

    epoll_data_t data;      // User datavariable

};

typedef union epoll_data {

    void *ptr;

   int fd;

    __uint32_t u32;

    __uint64_t u64;

} epoll_data_t;
</code></pre><p>ç»“æ„ä½“epoll_event è¢«ç”¨äºæ³¨å†Œæ‰€æ„Ÿå…´è¶£çš„äº‹ä»¶å’Œå›ä¼ æ‰€å‘ç”Ÿå¾…å¤„ç†çš„äº‹ä»¶.<br>å…¶ä¸­epoll_data è”åˆä½“ç”¨æ¥ä¿å­˜è§¦å‘äº‹ä»¶çš„æŸä¸ªæ–‡ä»¶æè¿°ç¬¦ç›¸å…³çš„æ•°æ®.<br>ä¾‹å¦‚ä¸€ä¸ªclientè¿æ¥åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨é€šè¿‡è°ƒç”¨acceptå‡½æ•°å¯ä»¥å¾—åˆ°äºè¿™ä¸ªclientå¯¹åº”çš„socketæ–‡ä»¶æè¿°ç¬¦ï¼Œå¯ä»¥æŠŠè¿™æ–‡ä»¶æè¿°ç¬¦èµ‹ç»™epoll_dataçš„fdå­—æ®µä»¥ä¾¿åé¢çš„è¯»å†™æ“ä½œåœ¨è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸Šè¿›è¡Œã€‚epoll_event ç»“æ„ä½“çš„eventså­—æ®µæ˜¯è¡¨ç¤ºæ„Ÿå…´è¶£çš„äº‹ä»¶å’Œè¢«è§¦å‘çš„äº‹ä»¶å¯èƒ½çš„å–å€¼ä¸ºï¼š </p>
<ul>
<li>EPOLLIN ï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¯»ï¼›</li>
<li>EPOLLOUTï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥å†™ï¼›</li>
<li>EPOLLPRIï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦æœ‰ç´§æ€¥çš„æ•°æ®å¯è¯»</li>
<li>EPOLLERRï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯ï¼›</li>
<li>EPOLLHUPï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦è¢«æŒ‚æ–­ï¼›</li>
<li>EPOLLETï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦æœ‰äº‹ä»¶å‘ç”Ÿï¼›</li>
</ul>
<p><strong>ETå’ŒLTæ¨¡å¼</strong><br>LT(level triggered)æ˜¯ç¼ºçœçš„å·¥ä½œæ–¹å¼ï¼Œå¹¶ä¸”åŒæ—¶æ”¯æŒblockå’Œno-block socket.åœ¨è¿™ç§åšæ³•ä¸­ï¼Œå†…æ ¸å‘Šè¯‰ä½ ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å°±ç»ªäº†ï¼Œç„¶åä½ å¯ä»¥å¯¹è¿™ä¸ªå°±ç»ªçš„fdè¿›è¡ŒIOæ“ä½œã€‚å¦‚æœä½ ä¸ä½œä»»ä½•æ“ä½œï¼Œå†…æ ¸è¿˜æ˜¯ä¼šç»§ç»­é€šçŸ¥ä½ çš„ï¼Œæ‰€ä»¥ï¼Œè¿™ç§æ¨¡å¼ç¼–ç¨‹å‡ºé”™è¯¯å¯èƒ½æ€§è¦å°ä¸€ç‚¹ã€‚ä¼ ç»Ÿçš„select/polléƒ½æ˜¯è¿™ç§æ¨¡å‹çš„ä»£è¡¨ã€‚</p>
<p>ET (edge-triggered)æ˜¯é«˜é€Ÿå·¥ä½œæ–¹å¼ï¼Œåªæ”¯æŒno-block socketã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå½“æè¿°ç¬¦ä»æœªå°±ç»ªå˜ä¸ºå°±ç»ªæ—¶ï¼Œå†…æ ¸é€šè¿‡epollå‘Šè¯‰ä½ ã€‚ç„¶åå®ƒä¼šå‡è®¾ä½ çŸ¥é“æ–‡ä»¶æè¿°ç¬¦å·²ç»å°±ç»ªï¼Œå¹¶ä¸”ä¸ä¼šå†ä¸ºé‚£ä¸ªæ–‡ä»¶æè¿°ç¬¦å‘é€æ›´å¤šçš„å°±ç»ªé€šçŸ¥ï¼Œç›´åˆ°ä½ åšäº†æŸäº›æ“ä½œå¯¼è‡´é‚£ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸å†ä¸ºå°±ç»ªçŠ¶æ€äº†ï¼ˆæ¯”å¦‚ï¼Œä½ åœ¨å‘é€ï¼Œæ¥æ”¶æˆ–è€…æ¥æ”¶è¯·æ±‚ï¼Œæˆ–è€…å‘é€æ¥æ”¶çš„æ•°æ®å°‘äºä¸€å®šé‡æ—¶å¯¼è‡´äº†ä¸€ä¸ªEWOULDBLOCK é”™è¯¯ï¼‰ã€‚ä½†æ˜¯è¯·æ³¨æ„ï¼Œå¦‚æœä¸€ç›´ä¸å¯¹è¿™ä¸ªfdä½œIOæ“ä½œï¼ˆä»è€Œå¯¼è‡´å®ƒå†æ¬¡å˜æˆæœªå°±ç»ªï¼‰ï¼Œå†…æ ¸ä¸ä¼šå‘é€æ›´å¤šçš„é€šçŸ¥(only once)ï¼Œä¸è¿‡åœ¨TCPåè®®ä¸­ï¼ŒETæ¨¡å¼çš„åŠ é€Ÿæ•ˆç”¨ä»éœ€è¦æ›´å¤šçš„benchmarkç¡®è®¤ã€‚<br>ETå’ŒLTçš„åŒºåˆ«åœ¨äºLTäº‹ä»¶ä¸ä¼šä¸¢å¼ƒï¼Œè€Œæ˜¯åªè¦è¯»bufferé‡Œé¢æœ‰æ•°æ®å¯ä»¥è®©ç”¨æˆ·è¯»ï¼Œåˆ™ä¸æ–­çš„é€šçŸ¥ä½ ã€‚è€ŒETåˆ™åªåœ¨äº‹ä»¶å‘ç”Ÿä¹‹æ—¶é€šçŸ¥ã€‚å¯ä»¥ç®€å•ç†è§£ä¸ºLTæ˜¯æ°´å¹³è§¦å‘ï¼Œè€ŒETåˆ™ä¸ºè¾¹ç¼˜è§¦å‘ã€‚<br>ETæ¨¡å¼ä»…å½“çŠ¶æ€å‘ç”Ÿå˜åŒ–çš„æ—¶å€™æ‰è·å¾—é€šçŸ¥,è¿™é‡Œæ‰€è°“çš„çŠ¶æ€çš„å˜åŒ–å¹¶ä¸åŒ…æ‹¬ç¼“å†²åŒºä¸­è¿˜æœ‰æœªå¤„ç†çš„æ•°æ®,ä¹Ÿå°±æ˜¯è¯´,å¦‚æœè¦é‡‡ç”¨ETæ¨¡å¼,éœ€è¦ä¸€ç›´read/writeç›´åˆ°å‡ºé”™ä¸ºæ­¢,å¾ˆå¤šäººåæ˜ ä¸ºä»€ä¹ˆé‡‡ç”¨ETæ¨¡å¼åªæ¥æ”¶äº†ä¸€éƒ¨åˆ†æ•°æ®å°±å†ä¹Ÿå¾—ä¸åˆ°é€šçŸ¥äº†,å¤§å¤šå› ä¸ºè¿™æ ·;è€ŒLTæ¨¡å¼æ˜¯åªè¦æœ‰æ•°æ®æ²¡æœ‰å¤„ç†å°±ä¼šä¸€ç›´é€šçŸ¥ä¸‹å»çš„.</p>
<h2 id="6-ä½¿ç”¨Epoll"><a href="#6-ä½¿ç”¨Epoll" class="headerlink" title="6. ä½¿ç”¨Epoll"></a>6. ä½¿ç”¨Epoll</h2><p>æ—¢ç„¶Epollç›¸æ¯”selectè¿™ä¹ˆå¥½ï¼Œé‚£ä¹ˆç”¨èµ·æ¥å¦‚ä½•å‘¢ï¼Ÿä¼šä¸ä¼šå¾ˆç¹çå•Šâ€¦å…ˆçœ‹çœ‹ä¸‹é¢çš„ä¸‰ä¸ªå‡½æ•°å§ï¼Œå°±çŸ¥é“Epollçš„æ˜“ç”¨äº†ã€‚</p>
<pre><code>int epoll_create(int size);
</code></pre><p>ç”Ÿæˆä¸€ä¸ªEpollä¸“ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå…¶å®æ˜¯ç”³è¯·ä¸€ä¸ªå†…æ ¸ç©ºé—´ï¼Œç”¨æ¥å­˜æ”¾ä½ æƒ³å…³æ³¨çš„socket fdä¸Šæ˜¯å¦å‘ç”Ÿä»¥åŠå‘ç”Ÿäº†ä»€ä¹ˆäº‹ä»¶ã€‚sizeå°±æ˜¯ä½ åœ¨è¿™ä¸ªEpoll fdä¸Šèƒ½å…³æ³¨çš„æœ€å¤§socket fdæ•°ï¼Œå¤§å°è‡ªå®šï¼Œåªè¦å†…å­˜è¶³å¤Ÿã€‚</p>
<pre><code>int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);
</code></pre><p>epollçš„äº‹ä»¶æ³¨å†Œå‡½æ•°ï¼Œå®ƒä¸åŒä¸select()æ˜¯åœ¨ç›‘å¬äº‹ä»¶æ—¶å‘Šè¯‰å†…æ ¸è¦ç›‘å¬ä»€ä¹ˆç±»å‹çš„äº‹ä»¶ï¼Œè€Œæ˜¯åœ¨è¿™é‡Œå…ˆæ³¨å†Œè¦ç›‘å¬çš„äº‹ä»¶ç±»å‹ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯epoll_create()çš„è¿”å›å€¼ï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºåŠ¨ä½œï¼Œç”¨ä¸‰ä¸ªå®æ¥è¡¨ç¤ºï¼š</p>
<ul>
<li>EPOLL_CTL_ADDï¼šæ³¨å†Œæ–°çš„fdåˆ°epfdä¸­ï¼›</li>
<li>EPOLL_CTL_MODï¼šä¿®æ”¹å·²ç»æ³¨å†Œçš„fdçš„ç›‘å¬äº‹ä»¶ï¼›</li>
<li>EPOLL_CTL_DELï¼šä»epfdä¸­åˆ é™¤ä¸€ä¸ªfdï¼›</li>
</ul>
<p>ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯éœ€è¦ç›‘å¬çš„fdï¼Œç¬¬å››ä¸ªå‚æ•°æ˜¯å‘Šè¯‰å†…æ ¸éœ€è¦ç›‘å¬ä»€ä¹ˆäº‹</p>
<pre><code>int epoll_wait(int epfd,struct epoll_event * events,int maxevents,int timeout);
</code></pre><p>ç­‰å¾…I/Oäº‹ä»¶çš„å‘ç”Ÿï¼›å‚æ•°è¯´æ˜ï¼š</p>
<ul>
<li>epfd:ç”±epoll_create() ç”Ÿæˆçš„Epollä¸“ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼›</li>
<li>epoll_event:ç”¨äºå›ä¼ ä»£å¤„ç†äº‹ä»¶çš„æ•°ç»„ï¼›</li>
<li>maxevents:æ¯æ¬¡èƒ½å¤„ç†çš„äº‹ä»¶æ•°ï¼›</li>
<li>timeout:ç­‰å¾…I/Oäº‹ä»¶å‘ç”Ÿçš„è¶…æ—¶å€¼ï¼›</li>
<li>è¿”å›å‘ç”Ÿäº‹ä»¶æ•°ã€‚</li>
</ul>
<hr>
<hr>
<h2 id="æµ‹è¯•ç¨‹åº"><a href="#æµ‹è¯•ç¨‹åº" class="headerlink" title="æµ‹è¯•ç¨‹åº"></a>æµ‹è¯•ç¨‹åº</h2><p>é¦–å…ˆå¯¹æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åšä¸‹è¯´æ˜ï¼š<br>æˆ‘æƒ³å®ç°çš„æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¹¶å‘çš„ç¨‹åºï¼Œå®¢æˆ·ç«¯é€šè¿‡é…ç½®å¹¶å‘æ•°ï¼Œè¯´æ˜æœ‰å¤šå°‘ä¸ªç”¨æˆ·å»è¿æ¥æœåŠ¡ç«¯ã€‚<br>å®¢æˆ·ç«¯ä¼šå‘é€æ¶ˆæ¯ï¼šâ€Client: i send message Hello Server!â€ï¼Œå…¶ä¸­iè¡¨ç¤ºå“ªä¸€ä¸ªå®¢æˆ·ç«¯ï¼›æ”¶åˆ°æ¶ˆæ¯ï¼šâ€Recv Server Msg Content:%s\nâ€ã€‚<br>ä¾‹å¦‚ï¼š<br>å‘é€ï¼šClient: 1 send message â€œHello Server!â€<br>æ¥æ”¶ï¼šRecv Derver Msg Content:Hello, client fd: 6<br>æœåŠ¡ç«¯æ”¶åˆ°åç»™å®¢æˆ·ç«¯å›å¤æ¶ˆæ¯ï¼šâ€Hello, client fd: iâ€ï¼Œå…¶ä¸­iè¡¨ç¤ºæœåŠ¡ç«¯æ¥æ”¶çš„fd,ç”¨æˆ·åŒºåˆ«æ˜¯å“ªä¸€ä¸ªå®¢æˆ·ç«¯ã€‚æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯ï¼šâ€Terminal Received Msg Content:%s\nâ€<br>ä¾‹å¦‚ï¼š<br>å‘é€ï¼šHello, client fd: 6<br>æ¥æ”¶ï¼šTerminal Received Msg Content:Client: 1 send message â€œHello Server!â€<br>å¤‡æ³¨ï¼šè¿™é‡Œåœ¨æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œç›´æ¥æ‰“å°å‡ºæ¶ˆæ¯ï¼Œå¦‚æœéœ€è¦å¯¹æ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼ˆå¦‚æœæ¶ˆæ¯å¤„ç†æ¯”è¾ƒå ç”¨æ—¶é—´ï¼Œä¸èƒ½ç«‹å³è¿”å›ï¼Œå¯ä»¥å°†è¯¥æ¶ˆæ¯æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶åå¼€å¯ä¸€ä¸ªçº¿ç¨‹ä»é˜Ÿåˆ—ä¸­å–æ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼Œè¿™æ ·çš„è¯ä¸ä¼šå› ä¸ºæ¶ˆæ¯å¤„ç†è€Œé˜»å¡epollï¼‰ã€‚libenentå¥½åƒå¯¹è¿™ç§æœ‰2ä¸­å¤„ç†æ–¹å¼ï¼Œä¸€ä¸ªå°±æ˜¯å›è°ƒï¼Œè¦æ±‚å›è°ƒå‡½æ•°ï¼Œä¸å ç”¨å¤ªå¤šçš„æ—¶é—´ï¼ŒåŸºæœ¬èƒ½ç«‹å³è¿”å›ï¼Œå¦ä¸€ç§å¥½åƒä¹Ÿæ˜¯ä¸€ä¸ªé˜Ÿåˆ—å®ç°çš„ï¼Œè¿™ä¸ªè¿˜éœ€è¦ç ”ç©¶ã€‚<br>æœåŠ¡ç«¯ä»£ç è¯´æ˜ï¼š<br>æœåŠ¡ç«¯åœ¨ç»‘å®šç›‘å¬åï¼Œå¼€å¯äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œç”¨äºè´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼ŒåŠ å…¥åˆ°epollä¸­ï¼Œè¿™æ ·åªè¦acceptåˆ°å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œå°±å°†å…¶add EPOLLINåˆ°epollä¸­ï¼Œç„¶åè¿›å…¥å¾ªç¯è°ƒç”¨epoll_waitï¼Œç›‘å¬åˆ°è¯»äº‹ä»¶ï¼Œæ¥æ”¶æ•°æ®ï¼Œå¹¶å°†äº‹ä»¶ä¿®æ”¹ä¸ºEPOLLOUTï¼›åä¹‹ç›‘å¬åˆ°å†™äº‹ä»¶ï¼Œå‘é€æ•°æ®ï¼Œå¹¶å°†äº‹ä»¶ä¿®æ”¹ä¸ºEPOLLINã€‚<br><strong>æœåŠ¡å™¨ä»£ç ï¼š</strong></p>
<pre><code>//cepollserver.h  
#ifndef  C_EPOLL_SERVER_H  
#define  C_EPOLL_SERVER_H  

#include &lt;sys/epoll.h&gt;  
#include &lt;sys/socket.h&gt;  
#include &lt;netinet/in.h&gt;  
#include &lt;fcntl.h&gt;  
#include &lt;arpa/inet.h&gt;  
#include &lt;stdio.h&gt;  
#include &lt;stdlib.h&gt;  
#include &lt;iostream&gt;  
#include &lt;pthread.h&gt;  

#define _MAX_SOCKFD_COUNT 65535  

class CEpollServer  
{  
        public:  
                CEpollServer();  
                ~CEpollServer();  

                bool InitServer(const char* chIp, int iPort);  
                void Listen();  
                static void ListenThread( void* lpVoid );  
                void Run();  

        private:  
                int        m_iEpollFd;  
                int        m_isock;  
                pthread_t       m_ListenThreadId;// ç›‘å¬çº¿ç¨‹å¥æŸ„  

};  

#endif  

   #include &quot;cepollserver.h&quot;  

using namespace std;  

CEpollServer::CEpollServer()  
{  
}  

CEpollServer::~CEpollServer()  
{  
    close(m_isock);  
}  

bool CEpollServer::InitServer(const char* pIp, int iPort)  
{  
    m_iEpollFd = epoll_create(_MAX_SOCKFD_COUNT);  

    //è®¾ç½®éé˜»å¡æ¨¡å¼  
    int opts = O_NONBLOCK;  
    if(fcntl(m_iEpollFd,F_SETFL,opts)&lt;0)  
    {  
        printf(&quot;è®¾ç½®éé˜»å¡æ¨¡å¼å¤±è´¥!\n&quot;);  
        return false;  
    }  

    m_isock = socket(AF_INET,SOCK_STREAM,0);  
    if ( 0 &gt; m_isock )  
    {  
        printf(&quot;socket error!\n&quot;);  
        return false;  
ã€€ã€€}  
ã€€ã€€  
ã€€ã€€sockaddr_in listen_addr;  
ã€€ã€€    listen_addr.sin_family=AF_INET;  
ã€€ã€€    listen_addr.sin_port=htons ( iPort );  
ã€€ã€€    listen_addr.sin_addr.s_addr=htonl(INADDR_ANY);  
ã€€ã€€    listen_addr.sin_addr.s_addr=inet_addr(pIp);  
ã€€ã€€  
ã€€ã€€    int ireuseadd_on = 1;//æ”¯æŒç«¯å£å¤ç”¨  
ã€€ã€€    setsockopt(m_isock, SOL_SOCKET, SO_REUSEADDR, &amp;ireuseadd_on, sizeof(ireuseadd_on) );  
ã€€ã€€  
ã€€ã€€    if ( bind ( m_isock, ( sockaddr * ) &amp;listen_addr,sizeof ( listen_addr ) ) !=0 )  
ã€€ã€€    {  
ã€€ã€€        printf(&quot;bind error\n&quot;);  
ã€€ã€€        return false;  
ã€€ã€€    }  
ã€€ã€€  
ã€€ã€€    if ( listen ( m_isock, 20) &lt;0 )  
ã€€ã€€    {  
ã€€ã€€        printf(&quot;listen error!\n&quot;);  
ã€€ã€€        return false;  
ã€€ã€€    }  
ã€€ã€€    else  
ã€€ã€€    {  
ã€€ã€€        printf(&quot;æœåŠ¡ç«¯ç›‘å¬ä¸­...\n&quot;);  
ã€€ã€€    }  
ã€€ã€€  
ã€€ã€€    // ç›‘å¬çº¿ç¨‹ï¼Œæ­¤çº¿ç¨‹è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼ŒåŠ å…¥åˆ°epollä¸­  
ã€€ã€€    if ( pthread_create( &amp;m_ListenThreadId, 0, ( void * ( * ) ( void * ) ) ListenThread, this ) != 0 )  
ã€€ã€€    {  
ã€€ã€€        printf(&quot;Server ç›‘å¬çº¿ç¨‹åˆ›å»ºå¤±è´¥!!!&quot;);  
ã€€ã€€        return false;  
ã€€ã€€    }  
ã€€ã€€}  
ã€€ã€€// ç›‘å¬çº¿ç¨‹  
ã€€ã€€void CEpollServer::ListenThread( void* lpVoid )  
ã€€ã€€{  
ã€€ã€€    CEpollServer *pTerminalServer = (CEpollServer*)lpVoid;  
ã€€ã€€    sockaddr_in remote_addr;  
ã€€ã€€    int len = sizeof (remote_addr);  
ã€€ã€€    while ( true )  
ã€€ã€€    {  
ã€€ã€€        int client_socket = accept (pTerminalServer-&gt;m_isock, ( sockaddr * ) &amp;remote_addr,(socklen_t*)&amp;len );  
ã€€ã€€        if ( client_socket &lt; 0 )  
ã€€ã€€        {  
ã€€ã€€            printf(&quot;Server Acceptå¤±è´¥!, client_socket: %d\n&quot;, client_socket);  
ã€€ã€€            continue;  
ã€€ã€€        }  
ã€€ã€€        else  
ã€€ã€€        {  
ã€€ã€€            struct epoll_event    ev;  
ã€€ã€€            ev.events = EPOLLIN | EPOLLERR | EPOLLHUP;  
ã€€ã€€            ev.data.fd = client_socket;     //è®°å½•socketå¥æŸ„  
ã€€ã€€            epoll_ctl(pTerminalServer-&gt;m_iEpollFd, EPOLL_CTL_ADD, client_socket, &amp;ev);  
ã€€ã€€        }  
ã€€ã€€    }  
ã€€ã€€}  
ã€€ã€€  
ã€€ã€€void CEpollServer::Run()  
ã€€ã€€{  
ã€€ã€€    while ( true )  
ã€€ã€€    {  
ã€€ã€€        struct epoll_event    events[_MAX_SOCKFD_COUNT];  
ã€€ã€€        int nfds = epoll_wait( m_iEpollFd, events,  _MAX_SOCKFD_COUNT, -1 );  
ã€€ã€€        for (int i = 0; i &lt; nfds; i++)  
ã€€ã€€        {  
ã€€ã€€            int client_socket = events[i].data.fd;  
ã€€ã€€            char buffer[1024];//æ¯æ¬¡æ”¶å‘çš„å­—èŠ‚æ•°å°äº1024å­—èŠ‚  
ã€€ã€€            memset(buffer, 0, 1024);  
ã€€ã€€            if (events[i].events &amp; EPOLLIN)//ç›‘å¬åˆ°è¯»äº‹ä»¶ï¼Œæ¥æ”¶æ•°æ®  
ã€€ã€€            {  
ã€€ã€€                int rev_size = recv(events[i].data.fd,buffer, 1024,0);  
ã€€ã€€                if( rev_size &lt;= 0 )  
ã€€ã€€                {  
ã€€ã€€                    cout &lt;&lt; &quot;recv error: recv size: &quot; &lt;&lt; rev_size &lt;&lt; endl;  
ã€€ã€€                    struct epoll_event event_del;  
ã€€ã€€                    event_del.data.fd = events[i].data.fd;  
ã€€ã€€                    event_del.events = 0;  
ã€€ã€€                    epoll_ctl(m_iEpollFd, EPOLL_CTL_DEL, event_del.data.fd, &amp;event_del);  
ã€€ã€€                }  
ã€€ã€€                else  
ã€€ã€€                {  
ã€€ã€€                    printf(&quot;Terminal Received Msg Content:%s\n&quot;,buffer);  
ã€€ã€€                    struct epoll_event    ev;  
ã€€ã€€                    ev.events = EPOLLOUT | EPOLLERR | EPOLLHUP;  
ã€€ã€€                    ev.data.fd = client_socket;     //è®°å½•socketå¥æŸ„  
ã€€ã€€                    epoll_ctl(m_iEpollFd, EPOLL_CTL_MOD, client_socket, &amp;ev);  
ã€€ã€€                }  
ã€€ã€€            }  
ã€€ã€€else if(events[i].events &amp; EPOLLOUT)//ç›‘å¬åˆ°å†™äº‹ä»¶ï¼Œå‘é€æ•°æ®  
ã€€ã€€            {  
ã€€ã€€                char sendbuff[1024];  
ã€€ã€€                sprintf(sendbuff, &quot;Hello, client fd: %d\n&quot;, client_socket);  
ã€€ã€€                int sendsize = send(client_socket, sendbuff, strlen(sendbuff)+1, MSG_NOSIGNAL);  
ã€€ã€€                if(sendsize &lt;= 0)  
ã€€ã€€                {  
ã€€ã€€                    struct epoll_event event_del;  
ã€€ã€€                    event_del.data.fd = events[i].data.fd;  
ã€€ã€€                    event_del.events = 0;  
ã€€ã€€                    epoll_ctl(m_iEpollFd, EPOLL_CTL_DEL, event_del.data.fd, &amp;event_del);  
ã€€ã€€                }  
ã€€ã€€                else  
ã€€ã€€                {  
ã€€ã€€                    printf(&quot;Server reply msg ok! buffer: %s\n&quot;, sendbuff);  
ã€€ã€€                    struct epoll_event    ev;  
ã€€ã€€                    ev.events = EPOLLIN | EPOLLERR | EPOLLHUP;  
ã€€ã€€                    ev.data.fd = client_socket;     //è®°å½•socketå¥æŸ„  
ã€€ã€€                    epoll_ctl(m_iEpollFd, EPOLL_CTL_MOD, client_socket, &amp;ev);  
ã€€ã€€                }  
ã€€ã€€            }  
ã€€ã€€            else  
ã€€ã€€            {  
ã€€ã€€                cout &lt;&lt; &quot;EPOLL ERROR\n&quot; &lt;&lt;endl;  
ã€€ã€€                epoll_ctl(m_iEpollFd, EPOLL_CTL_DEL, events[i].data.fd, &amp;events[i]);  
ã€€ã€€            }  
ã€€ã€€        }  
ã€€ã€€    }  
ã€€ã€€}  
</code></pre><p><strong>å®¢æˆ·ç«¯ä»£ç ï¼š</strong><br>è¯´æ˜ï¼šæµ‹è¯•æ˜¯ä¸¤ä¸ªå¹¶å‘è¿›è¡Œæµ‹è¯•ï¼Œæ¯ä¸€ä¸ªå®¢æˆ·ç«¯éƒ½æ˜¯ä¸€ä¸ªé•¿è¿æ¥ã€‚ä»£ç ä¸­åœ¨è¿æ¥æœåŠ¡å™¨ï¼ˆConnectToServerï¼‰æ—¶å°†ç”¨æˆ·IDå’Œsocketidå…³è”èµ·æ¥ã€‚ç”¨æˆ·IDå’Œsocketidæ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ã€‚</p>
<pre><code>    #ifndef _DEFINE_EPOLLCLIENT_H_  
    #define _DEFINE_EPOLLCLIENT_H_  
    #define _MAX_SOCKFD_COUNT 65535  

    #include&lt;iostream&gt;  
    #include &lt;sys/epoll.h&gt;  
    #include &lt;sys/socket.h&gt;  
    #include &lt;netinet/in.h&gt;  
    #include &lt;fcntl.h&gt;  
    #include &lt;arpa/inet.h&gt;  
    #include &lt;errno.h&gt;  
    #include &lt;sys/ioctl.h&gt;  
    #include &lt;sys/time.h&gt;  
    #include &lt;string&gt;  

    using namespace std;  

    /** 
     * @brief ç”¨æˆ·çŠ¶æ€ 
     */  
    typedef enum _EPOLL_USER_STATUS_EM  
    {  
            FREE = 0,  
            CONNECT_OK = 1,//è¿æ¥æˆåŠŸ  
            SEND_OK = 2,//å‘é€æˆåŠŸ  
            RECV_OK = 3,//æ¥æ”¶æˆåŠŸ  
    }EPOLL_USER_STATUS_EM;  

    /*@brief 
     *@CEpollClient class ç”¨æˆ·çŠ¶æ€ç»“æ„ä½“ 
     */  
    struct UserStatus  
    {  
            EPOLL_USER_STATUS_EM iUserStatus;//ç”¨æˆ·çŠ¶æ€  
            int iSockFd;//ç”¨æˆ·çŠ¶æ€å…³è”çš„socketfd  
            char cSendbuff[1024];//å‘é€çš„æ•°æ®å†…å®¹  
            int iBuffLen;//å‘é€æ•°æ®å†…å®¹çš„é•¿åº¦  
            unsigned int uEpollEvents;//Epoll events  
    };  

    class CEpollClient  
    {  
            public:  

                    /** 
                     * @brief 
                     * å‡½æ•°å:CEpollClient 
                     * æè¿°:æ„é€ å‡½æ•° 
                     * @param [in] iUserCount  
                     * @param [in] pIP IPåœ°å€ 
                     * @param [in] iPort ç«¯å£å· 
                     * @return æ— è¿”å› 
                     */  
                    CEpollClient(int iUserCount, const char* pIP, int iPort);  

    /** 
                     * @brief 
                     * å‡½æ•°å:CEpollClient 
                     * æè¿°:ææ„å‡½æ•° 
                     * @return æ— è¿”å› 
                     */  
                    ~CEpollClient();  

                    /** 
                     * @brief 
                     * å‡½æ•°å:RunFun 
                     * æè¿°:å¯¹å¤–æä¾›çš„æ¥å£ï¼Œè¿è¡Œepollç±» 
                     * @return æ— è¿”å›å€¼ 
                     */  
                    int RunFun();  

            private:  

                    /** 
                     * @brief 
                     * å‡½æ•°å:ConnectToServer 
                     * æè¿°:è¿æ¥åˆ°æœåŠ¡å™¨ 
                     * @param [in] iUserId ç”¨æˆ·ID 
                     * @param [in] pServerIp è¿æ¥çš„æœåŠ¡å™¨IP 
                     * @param [in] uServerPort è¿æ¥çš„æœåŠ¡å™¨ç«¯å£å· 
                     * @return æˆåŠŸè¿”å›socketfd,å¤±è´¥è¿”å›çš„socketfdä¸º-1 
                     */  
                    int ConnectToServer(int iUserId,const char *pServerIp,unsigned short uServerPort);  

    /** 
                     * @brief 
                     * å‡½æ•°å:SendToServerData 
                     * æè¿°:ç»™æœåŠ¡å™¨å‘é€ç”¨æˆ·(iUserId)çš„æ•°æ® 
                     * @param [in] iUserId ç”¨æˆ·ID 
                     * @return æˆåŠŸè¿”å›å‘é€æ•°æ®é•¿åº¦ 
                     */  
                    int SendToServerData(int iUserId);  

                    /** 
                     * @brief 
                     * å‡½æ•°å:RecvFromServer 
                     * æè¿°:æ¥æ”¶ç”¨æˆ·å›å¤æ¶ˆæ¯ 
                     * @param [in] iUserId ç”¨æˆ·ID 
                     * @param [in] pRecvBuff æ¥æ”¶çš„æ•°æ®å†…å®¹ 
                     * @param [in] iBuffLen æ¥æ”¶çš„æ•°æ®é•¿åº¦ 
                     * @return æˆåŠŸè¿”å›æ¥æ”¶çš„æ•°æ®é•¿åº¦ï¼Œå¤±è´¥è¿”å›é•¿åº¦ä¸º-1 
                     */  
                    int RecvFromServer(int iUserid,char *pRecvBuff,int iBuffLen);  

                    /** 
                     * @brief 
                     * å‡½æ•°å:CloseUser 
                     * æè¿°:å…³é—­ç”¨æˆ· 
                     * @param [in] iUserId ç”¨æˆ·ID 
                     * @return æˆåŠŸè¿”å›true 
                     */  
                    bool CloseUser(int iUserId);  

    /** 
                     * @brief 
                     * å‡½æ•°å:DelEpoll 
                     * æè¿°:åˆ é™¤epolläº‹ä»¶ 
                     * @param [in] iSockFd socket FD 
                     * @return æˆåŠŸè¿”å›true 
                     */  
                    bool DelEpoll(int iSockFd);  
            private:  

                    int    m_iUserCount;//ç”¨æˆ·æ•°é‡ï¼›  
                    struct UserStatus *m_pAllUserStatus;//ç”¨æˆ·çŠ¶æ€æ•°ç»„  
                    int    m_iEpollFd;//éœ€è¦åˆ›å»ºepollfd  
                    int    m_iSockFd_UserId[_MAX_SOCKFD_COUNT];//å°†ç”¨æˆ·IDå’Œsocketidå…³è”èµ·æ¥  
                    int    m_iPort;//ç«¯å£å·  
                    char   m_ip[100];//IPåœ°å€  
    };  

    #endif  
    #include &quot;cepollclient.h&quot;  

CEpollClient::CEpollClient(int iUserCount, const char* pIP, int iPort)  
{  
    strcpy(m_ip, pIP);  
    m_iPort = iPort;  
    m_iUserCount = iUserCount;  
    m_iEpollFd = epoll_create(_MAX_SOCKFD_COUNT);  
    m_pAllUserStatus = (struct UserStatus*)malloc(iUserCount*sizeof(struct UserStatus));  
    for(int iuserid=0; iuserid&lt;iUserCount ; iuserid++)  
    {  
        m_pAllUserStatus[iuserid].iUserStatus = FREE;  
        sprintf(m_pAllUserStatus[iuserid].cSendbuff, &quot;Client: %d send message \&quot;Hello Server!\&quot;\r\n&quot;, iuserid);  
        m_pAllUserStatus[iuserid].iBuffLen = strlen(m_pAllUserStatus[iuserid].cSendbuff) + 1;  
        m_pAllUserStatus[iuserid].iSockFd = -1;  
    }  
    memset(m_iSockFd_UserId, 0xFF, sizeof(m_iSockFd_UserId));  
}  

CEpollClient::~CEpollClient()  
{  
    free(m_pAllUserStatus);  
}  
int CEpollClient::ConnectToServer(int iUserId,const char *pServerIp,unsigned short uServerPort)  
{  
    if( (m_pAllUserStatus[iUserId].iSockFd = socket(AF_INET,SOCK_STREAM,0) ) &lt; 0 )  
    {  
        cout &lt;&lt;&quot;[CEpollClient error]: init socket fail, reason is:&quot;&lt;&lt;strerror(errno)&lt;&lt;&quot;,errno is:&quot;&lt;&lt;errno&lt;&lt;endl;  
        m_pAllUserStatus[iUserId].iSockFd = -1;  
        return  m_pAllUserStatus[iUserId].iSockFd;  
    }  

    struct sockaddr_in addr;  
    bzero(&amp;addr, sizeof(addr));  
    addr.sin_family = AF_INET;  
    addr.sin_port = htons(uServerPort);  
    addr.sin_addr.s_addr = inet_addr(pServerIp);  

    int ireuseadd_on = 1;//æ”¯æŒç«¯å£å¤ç”¨  
    setsockopt(m_pAllUserStatus[iUserId].iSockFd, SOL_SOCKET, SO_REUSEADDR, &amp;ireuseadd_on, sizeof(ireuseadd_on));  

    unsigned long ul = 1;  
    ioctl(m_pAllUserStatus[iUserId].iSockFd, FIONBIO, &amp;ul); //è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼  

    connect(m_pAllUserStatus[iUserId].iSockFd, (const sockaddr*)&amp;addr, sizeof(addr));  
    m_pAllUserStatus[iUserId].iUserStatus = CONNECT_OK;  
    m_pAllUserStatus[iUserId].iSockFd = m_pAllUserStatus[iUserId].iSockFd;  

    return m_pAllUserStatus[iUserId].iSockFd;  
}  
int CEpollClient::SendToServerData(int iUserId)  
{  
    sleep(1);//æ­¤å¤„æ§åˆ¶å‘é€é¢‘ç‡ï¼Œé¿å…ç‹‚æ‰“æ—¥å¿—ï¼Œæ­£å¸¸ä½¿ç”¨ä¸­éœ€è¦å»æ‰  
    int isendsize = -1;  
    if( CONNECT_OK == m_pAllUserStatus[iUserId].iUserStatus || RECV_OK == m_pAllUserStatus[iUserId].iUserStatus)  
    {  
        isendsize = send(m_pAllUserStatus[iUserId].iSockFd, m_pAllUserStatus[iUserId].cSendbuff, m_pAllUserStatus[iUserId  
].iBuffLen, MSG_NOSIGNAL);  
        if(isendsize &lt; 0)  
        {  
            cout &lt;&lt;&quot;[CEpollClient error]: SendToServerData, send fail, reason is:&quot;&lt;&lt;strerror(errno)&lt;&lt;&quot;,errno is:&quot;&lt;&lt;errno&lt;  
&lt;endl;  
        }  
        else  
        {  
            printf(&quot;[CEpollClient info]: iUserId: %d Send Msg Content:%s\n&quot;, iUserId, m_pAllUserStatus[iUserId].cSendbuff  
);  
            m_pAllUserStatus[iUserId].iUserStatus = SEND_OK;  
        }  
    }  
    return isendsize;  
}  
int CEpollClient::RecvFromServer(int iUserId,char *pRecvBuff,int iBuffLen)  
{  
    int irecvsize = -1;  
    if(SEND_OK == m_pAllUserStatus[iUserId].iUserStatus)  
    {  
        irecvsize = recv(m_pAllUserStatus[iUserId].iSockFd, pRecvBuff, iBuffLen, 0);  
        if(0 &gt; irecvsize)  
        {  
            cout &lt;&lt;&quot;[CEpollClient error]: iUserId: &quot; &lt;&lt; iUserId &lt;&lt; &quot;RecvFromServer, recv fail, reason is:&quot;&lt;&lt;strerror(errn  
o)&lt;&lt;&quot;,errno is:&quot;&lt;&lt;errno&lt;&lt;endl;  
        }  
        else if(0 == irecvsize)  
        {  
            cout &lt;&lt;&quot;[warning:] iUserId: &quot;&lt;&lt; iUserId &lt;&lt; &quot;RecvFromServer, STBæ”¶åˆ°æ•°æ®ä¸º0ï¼Œè¡¨ç¤ºå¯¹æ–¹æ–­å¼€è¿æ¥,irecvsize:&quot;&lt;&lt;ire  
cvsize&lt;&lt;&quot;,iSockFd:&quot;&lt;&lt; m_pAllUserStatus[iUserId].iSockFd &lt;&lt; endl;  
        }  
        else  
        {  
            printf(&quot;Recv Server Msg Content:%s\n&quot;, pRecvBuff);  
            m_pAllUserStatus[iUserId].iUserStatus = RECV_OK;  
        }  
    }  
    return irecvsize;  
}  

bool CEpollClient::CloseUser(int iUserId)  
{  
    close(m_pAllUserStatus[iUserId].iSockFd);  
    m_pAllUserStatus[iUserId].iUserStatus = FREE;  
    m_pAllUserStatus[iUserId].iSockFd = -1;  
    return true;  
}  

int CEpollClient::RunFun()  
{  
    int isocketfd = -1;  
    for(int iuserid=0; iuserid&lt;m_iUserCount; iuserid++)  
    {  
        struct epoll_event event;  
        isocketfd = ConnectToServer(iuserid, m_ip, m_iPort);  
        if(isocketfd &lt; 0)  
            cout &lt;&lt;&quot;[CEpollClient error]: RunFun, connect fail&quot; &lt;&lt;endl;  
        m_iSockFd_UserId[isocketfd] = iuserid;//å°†ç”¨æˆ·IDå’Œsocketidå…³è”èµ·æ¥  

        event.data.fd = isocketfd;  
        event.events = EPOLLIN|EPOLLOUT|EPOLLERR|EPOLLHUP;  

        m_pAllUserStatus[iuserid].uEpollEvents = event.events;  
        epoll_ctl(m_iEpollFd, EPOLL_CTL_ADD, event.data.fd, &amp;event);  
ã€€ã€€}  
ã€€ã€€while(1)  
ã€€ã€€    {  
ã€€ã€€        struct epoll_event events[_MAX_SOCKFD_COUNT];  
ã€€ã€€        char buffer[1024];  
ã€€ã€€        memset(buffer,0,1024);  
ã€€ã€€        int nfds = epoll_wait(m_iEpollFd, events, _MAX_SOCKFD_COUNT, 100 );//ç­‰å¾…epolläº‹ä»¶çš„äº§ç”Ÿ  
ã€€ã€€        for (int ifd=0; ifd&lt;nfds; ifd++)//å¤„ç†æ‰€å‘ç”Ÿçš„æ‰€æœ‰äº‹ä»¶  
ã€€ã€€        {  
ã€€ã€€            struct epoll_event event_nfds;  
ã€€ã€€            int iclientsockfd = events[ifd].data.fd;  
ã€€ã€€            cout &lt;&lt; &quot;events[ifd].data.fd: &quot; &lt;&lt; events[ifd].data.fd &lt;&lt; endl;  
ã€€ã€€            int iuserid = m_iSockFd_UserId[iclientsockfd];//æ ¹æ®socketfdå¾—åˆ°ç”¨æˆ·ID  
ã€€ã€€            if( events[ifd].events &amp; EPOLLOUT )  
ã€€ã€€            {  
ã€€ã€€                int iret = SendToServerData(iuserid);  
ã€€ã€€                if( 0 &lt; iret )  
ã€€ã€€                {  
ã€€ã€€                    event_nfds.events = EPOLLIN|EPOLLERR|EPOLLHUP;  
ã€€ã€€                    event_nfds.data.fd = iclientsockfd;  
ã€€ã€€                    epoll_ctl(m_iEpollFd, EPOLL_CTL_MOD, event_nfds.data.fd, &amp;event_nfds);  
ã€€ã€€                }  
ã€€ã€€                else  
ã€€ã€€                {  
ã€€ã€€                    cout &lt;&lt;&quot;[CEpollClient error:] EpollWait, SendToServerData fail, send iret:&quot;&lt;&lt;iret&lt;&lt;&quot;,iuserid:&quot;&lt;&lt;iuser  
ã€€ã€€id&lt;&lt;&quot;,fd:&quot;&lt;&lt;events[ifd].data.fd&lt;&lt;endl;  
ã€€ã€€                    DelEpoll(events[ifd].data.fd);  
ã€€ã€€                    CloseUser(iuserid);  
ã€€ã€€                }  
ã€€ã€€            }  
ã€€ã€€else if( events[ifd].events &amp; EPOLLIN )//ç›‘å¬åˆ°è¯»äº‹ä»¶ï¼Œæ¥æ”¶æ•°æ®  
ã€€ã€€            {  
ã€€ã€€                int ilen = RecvFromServer(iuserid, buffer, 1024);  
ã€€ã€€                if(0 &gt; ilen)  
ã€€ã€€                {  
ã€€ã€€                    cout &lt;&lt;&quot;[CEpollClient error]: RunFun, recv fail, reason is:&quot;&lt;&lt;strerror(errno)&lt;&lt;&quot;,errno is:&quot;&lt;&lt;errno&lt;&lt;e  
ã€€ã€€ndl;  
ã€€ã€€                    DelEpoll(events[ifd].data.fd);  
ã€€ã€€                    CloseUser(iuserid);  
ã€€ã€€                }  
ã€€ã€€                else if(0 == ilen)  
ã€€ã€€                {  
ã€€ã€€                    cout &lt;&lt;&quot;[CEpollClient warning:] server disconnect,ilen:&quot;&lt;&lt;ilen&lt;&lt;&quot;,iuserid:&quot;&lt;&lt;iuserid&lt;&lt;&quot;,fd:&quot;&lt;&lt;events[  
ã€€ã€€ifd].data.fd&lt;&lt;endl;  
ã€€ã€€                    DelEpoll(events[ifd].data.fd);  
ã€€ã€€                    CloseUser(iuserid);  
ã€€ã€€                }  
ã€€ã€€                else  
ã€€ã€€                {  
ã€€ã€€                    m_iSockFd_UserId[iclientsockfd] = iuserid;//å°†socketfdå’Œç”¨æˆ·IDå…³è”èµ·æ¥  
ã€€ã€€                    event_nfds.data.fd = iclientsockfd;  
ã€€ã€€                    event_nfds.events = EPOLLOUT|EPOLLERR|EPOLLHUP;  
ã€€ã€€                    epoll_ctl(m_iEpollFd, EPOLL_CTL_MOD, event_nfds.data.fd, &amp;event_nfds);  
ã€€ã€€                }  
ã€€ã€€            }  
ã€€ã€€            else  
ã€€ã€€            {  
ã€€ã€€                cout &lt;&lt;&quot;[CEpollClient error:] other epoll error&quot;&lt;&lt;endl;  
ã€€ã€€                DelEpoll(events[ifd].data.fd);  
ã€€ã€€                CloseUser(iuserid);  
ã€€ã€€            }  
ã€€ã€€        }  
ã€€ã€€}  
ã€€ã€€}  
ã€€ã€€  
ã€€ã€€bool CEpollClient::DelEpoll(int iSockFd)  
ã€€ã€€{  
ã€€ã€€    bool bret = false;  
ã€€ã€€    struct epoll_event event_del;  
ã€€ã€€    if(0 &lt; iSockFd)  
ã€€ã€€    {  
ã€€ã€€        event_del.data.fd = iSockFd;  
ã€€ã€€        event_del.events = 0;  
ã€€ã€€        if( 0 == epoll_ctl(m_iEpollFd, EPOLL_CTL_DEL, event_del.data.fd, &amp;event_del) )  
ã€€ã€€        {  
ã€€ã€€            bret = true;  
ã€€ã€€        }  
ã€€ã€€        else  
ã€€ã€€        {  
ã€€ã€€            cout &lt;&lt;&quot;[SimulateStb error:] DelEpoll,epoll_ctl error,iSockFd:&quot;&lt;&lt;iSockFd&lt;&lt;endl;  
ã€€ã€€        }  
ã€€ã€€        m_iSockFd_UserId[iSockFd] = -1;  
ã€€ã€€    }  
ã€€ã€€    else  
ã€€ã€€    {  
ã€€ã€€        bret = true;  
ã€€ã€€  
ã€€ã€€    }  
ã€€ã€€    return bret;  
ã€€ã€€}  
ã€€ã€€
</code></pre><p>æœåŠ¡å™¨ä¸»ç¨‹åºï¼š</p>
<pre><code>#include &lt;iostream&gt;  
#include &quot;cepollserver.h&quot;  

using namespace std;  

int main()  
{  
        CEpollServer  theApp;  
        theApp.InitServer(&quot;127.0.0.1&quot;, 8000);  
        theApp.Run();  

        return 0;  
}  
</code></pre><p>å®¢æˆ·ç«¯ä¸»ç¨‹åºï¼š</p>
<pre><code>    ã€€#include &quot;cepollclient.h&quot;  

int main(int argc, char *argv[])  
{  
        CEpollClient *pCEpollClient = new CEpollClient(2, &quot;127.0.0.1&quot;, 8000);  
        if(NULL == pCEpollClient)  
        {  
                cout&lt;&lt;&quot;[epollclient error]:main init&quot;&lt;&lt;&quot;Init CEpollClient fail&quot;&lt;&lt;endl;  
        }  

        pCEpollClient-&gt;RunFun();  

        if(NULL != pCEpollClient)  
        {  
                delete pCEpollClient;  
                pCEpollClient = NULL;  
        }  

        return 0;  
}  
</code></pre>
      
    </div>

    <div>
      
        

      
    </div>
  
        <div class="post-tags">
          
            <a href="/tags/c/" rel="tag"># c++</a>
          
            <a href="/tags/concurrent/" rel="tag"># concurrent</a>
          
        </div>
      


    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>ğŸ¶ æ‚¨çš„æ”¯æŒå°†é¼“åŠ±æˆ‘ç»§ç»­åˆ›ä½œ ğŸ¶</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>èµèµ</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/images/wechat-reward-img.jpg" alt="EZLippi WeChat Pay"/>
          <p>å¾®ä¿¡æ‰“èµ</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/images/alipay-reward-img.jpg" alt="EZLippi Alipay"/>
          <p>æ”¯ä»˜å®æ‰“èµ</p>
        </div>
      
    </div>
  </div>


      
    </div>


    <footer class="post-footer">
        
     <div>    
      
      <ul class="post-copyright">
         <li class="post-copyright-link">
          <strong>æœ¬æ–‡ä½œè€…ï¼š</strong>
          <a href="/" title="æ¬¢è¿è®¿é—® EZLippi çš„ä¸ªäººåšå®¢">EZLippi</a>
        </li>

        <li class="post-copyright-link">
          <strong>æœ¬æ–‡æ ‡é¢˜ï¼š</strong>
          <a href="http://www.ezlippi.com/blog/2014/08/linux-epoll.html" title="å¤„ç†å¹¶å‘ä¹‹ä¸€ï¼šLINUX Epollæœºåˆ¶ä»‹ç»">å¤„ç†å¹¶å‘ä¹‹ä¸€ï¼šLINUX Epollæœºåˆ¶ä»‹ç»</a>
        </li>

        <li class="post-copyright-link">
          <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
          <a href="http://www.ezlippi.com/blog/2014/08/linux-epoll.html" title="å¤„ç†å¹¶å‘ä¹‹ä¸€ï¼šLINUX Epollæœºåˆ¶ä»‹ç»">http://www.ezlippi.com/blog/2014/08/linux-epoll.html</a>
        </li>

        <li class="post-copyright-date">
            <strong>å‘å¸ƒæ—¶é—´ï¼š</strong>2014å¹´8æœˆ23æ—¥ - 00æ—¶08åˆ†
        </li>  

        <li class="post-copyright-license">
          <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>
          æœ¬æ–‡ç”± EZLippi åŸåˆ›ï¼Œé‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" rel="license" target="_blank">ä¿ç•™ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0-å›½é™…è®¸å¯åè®®</a> </br>è½¬è½½è¯·ä¿ç•™ä»¥ä¸Šå£°æ˜ä¿¡æ¯ï¼
        </li>
      </ul>
    
  </div>  
      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/2014/08/78-golden-rules-of-the-java-programming.html" rel="next" title="javaç¼–ç¨‹çš„78æ¡é»„é‡‘æ³•åˆ™">
                <i class="fa fa-chevron-left"></i> javaç¼–ç¨‹çš„78æ¡é»„é‡‘æ³•åˆ™
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/2014/08/libevent.html" rel="prev" title="å¤„ç†å¹¶å‘ä¹‹äºŒï¼šlibeventçš„eventbuffer">
                å¤„ç†å¹¶å‘ä¹‹äºŒï¼šlibeventçš„eventbuffer <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zMjI4My84ODQ3"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="EZLippi" />
          <p class="site-author-name" itemprop="name">EZLippi</p>
          <p class="site-description motion-element" itemprop="description">Easy Lippi</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">95</span>
                <span class="site-state-item-name">æ—¥å¿—</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">30</span>
                <span class="site-state-item-name">åˆ†ç±»</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">103</span>
                <span class="site-state-item-name">æ ‡ç­¾</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/EZLippi" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/ouyanglip" target="_blank" title="weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/lippi-ouyang" target="_blank" title="zhihu">
                  
                    <i class="fa fa-fw fa-battery-3"></i>
                  
                  zhihu
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              å‹æƒ…é“¾æ¥
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.woaitqs.cc/" title="Qisen Tang" target="_blank">Qisen Tang</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://szhshp.org" title="szhshpçš„åšå®¢" target="_blank">szhshpçš„åšå®¢</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://python.zhangwei.website" title="JuniorCoder" target="_blank">JuniorCoder</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://hippo-jessy.com" title="Hippo" target="_blank">Hippo</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.zhihu.com/people/lippi-ouyang" title="å‹é“¾å‡ºç§Ÿ" target="_blank">å‹é“¾å‡ºç§Ÿ</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-å¸¸ç”¨æ¨¡å‹çš„ç¼ºç‚¹"><span class="nav-number">1.</span> <span class="nav-text">2. å¸¸ç”¨æ¨¡å‹çš„ç¼ºç‚¹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-PPC-TPCæ¨¡å‹"><span class="nav-number">1.1.</span> <span class="nav-text">2.1 PPC/TPCæ¨¡å‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-selectæ¨¡å‹"><span class="nav-number">1.2.</span> <span class="nav-text">2.2 selectæ¨¡å‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-pollæ¨¡å‹"><span class="nav-number">1.3.</span> <span class="nav-text">2.3 pollæ¨¡å‹</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Epollçš„æå‡"><span class="nav-number">2.</span> <span class="nav-text">3.Epollçš„æå‡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Epollä¸ºä»€ä¹ˆé«˜æ•ˆ"><span class="nav-number">3.</span> <span class="nav-text">4. Epollä¸ºä»€ä¹ˆé«˜æ•ˆ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Epollå…³é”®æ•°æ®ç»“æ„"><span class="nav-number">4.</span> <span class="nav-text">5. Epollå…³é”®æ•°æ®ç»“æ„</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-ä½¿ç”¨Epoll"><span class="nav-number">5.</span> <span class="nav-text">6. ä½¿ç”¨Epoll</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æµ‹è¯•ç¨‹åº"><span class="nav-number">6.</span> <span class="nav-text">æµ‹è¯•ç¨‹åº</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">EZLippi</span>
</div>


<div class="powered-by">
  ç”± <a class="theme-link" href="https://hexo.io" rel="external nofollow">Hexo</a> å¼ºåŠ›é©±åŠ¨
</div>

<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next" rel="external nofollow">
    NexT.Mist
  </a>| Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a>
</div>





        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  
      <!-- UY BEGIN -->
      <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid="></script>
      <!-- UY END -->
  



  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  


  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("kJ2sJuSJeByLioULSXrJ5CSq-9Nh9j0Va", "uBWeNxCbFEWsOVDTmAInrDq3");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

	<!-- é¡µé¢ç‚¹å‡»å°çº¢å¿ƒ -->
<script type="text/javascript" src="/js/src/love.js"></script>

</body>
</html>
