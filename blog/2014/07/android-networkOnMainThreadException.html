<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
    
  
  <link href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






  

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="java" />





  <link rel="alternate" href="/atom.xml" title="EZLippi-æµ®ç”Ÿå¿—" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="æœ€è¿‘åœ¨å†™ä¸€ä¸ªç½‘ç»œé€šä¿¡çš„ç¨‹åºï¼Œè¿è¡Œçš„æ—¶å€™æŠ›å‡ºäº†è¿™æ ·ä¸€ä¸ªå¼‚å¸¸ï¼Œandroid.os.NetworkOnMainThreadExceptionï¼Œæ‰¾äº†å¾ˆä¹…æ²¡å‘ç°åŸå› ï¼Œåæ¥æŸ¥äº†ä¸‹èµ„æ–™æ‰çŸ¥é“æ˜¯androidçš„UIçº¿ç¨‹ä¸èƒ½ç›´æ¥è¿›è¡Œç½‘ç»œè®¿é—®çš„æ“ä½œã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="ä»android.os.NetworkOnMainThreadExceptionå¼•å‘çš„æ€è€ƒ">
<meta property="og:url" content="http://www.ezlippi.com/blog/2014/07/android-networkOnMainThreadException.html">
<meta property="og:site_name" content="EZLippi-æµ®ç”Ÿå¿—">
<meta property="og:description" content="æœ€è¿‘åœ¨å†™ä¸€ä¸ªç½‘ç»œé€šä¿¡çš„ç¨‹åºï¼Œè¿è¡Œçš„æ—¶å€™æŠ›å‡ºäº†è¿™æ ·ä¸€ä¸ªå¼‚å¸¸ï¼Œandroid.os.NetworkOnMainThreadExceptionï¼Œæ‰¾äº†å¾ˆä¹…æ²¡å‘ç°åŸå› ï¼Œåæ¥æŸ¥äº†ä¸‹èµ„æ–™æ‰çŸ¥é“æ˜¯androidçš„UIçº¿ç¨‹ä¸èƒ½ç›´æ¥è¿›è¡Œç½‘ç»œè®¿é—®çš„æ“ä½œã€‚">
<meta property="og:updated_time" content="2016-02-29T12:33:37.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ä»android.os.NetworkOnMainThreadExceptionå¼•å‘çš„æ€è€ƒ">
<meta name="twitter:description" content="æœ€è¿‘åœ¨å†™ä¸€ä¸ªç½‘ç»œé€šä¿¡çš„ç¨‹åºï¼Œè¿è¡Œçš„æ—¶å€™æŠ›å‡ºäº†è¿™æ ·ä¸€ä¸ªå¼‚å¸¸ï¼Œandroid.os.NetworkOnMainThreadExceptionï¼Œæ‰¾äº†å¾ˆä¹…æ²¡å‘ç°åŸå› ï¼Œåæ¥æŸ¥äº†ä¸‹èµ„æ–™æ‰çŸ¥é“æ˜¯androidçš„UIçº¿ç¨‹ä¸èƒ½ç›´æ¥è¿›è¡Œç½‘ç»œè®¿é—®çš„æ“ä½œã€‚">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 'undefined',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.ezlippi.com/blog/2014/07/android-networkOnMainThreadException.html"/>





<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*è¿›åº¦æ¡é¢œè‰²*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*é˜´å½±é¢œè‰²*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*ä¸Šè¾¹æ¡†é¢œè‰²*/
        border-left-color: #1E92FB;    /*å·¦è¾¹æ¡†é¢œè‰²*/
    }
</style>

  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "d1b06a58"
    });
  daovoice('update');
  </script>


  <title> ä»android.os.NetworkOnMainThreadExceptionå¼•å‘çš„æ€è€ƒ | EZLippi-æµ®ç”Ÿå¿— </title>
</head>

  	 <!-- custom analytics part create by xiamo -->
<script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
<script>AV.initialize("kJ2sJuSJeByLioULSXrJ5CSq-9Nh9j0Va", "uBWeNxCbFEWsOVDTmAInrDq3");</script>
<script>
function showTime(Counter) {
	var query = new AV.Query(Counter);
	$(".leancloud_visitors").each(function() {
		var url = $(this).attr("id").trim();
		query.equalTo("url", url);
		query.find({
			success: function(results) {
				if (results.length == 0) {
					var content = $(document.getElementById(url)).text() + ': 0';
					$(document.getElementById(url)).text(content);
					return;
				}
				for (var i = 0; i < results.length; i++) {
					var object = results[i];
					var content = $(document.getElementById(url)).text() + ': ' + object.get('time');
					$(document.getElementById(url)).text(content);
				}
			},
			error: function(object, error) {
				console.log("Error: " + error.code + " " + error.message);
			}
		});

	});
}

function addCount(Counter) {
	var Counter = AV.Object.extend("Counter");
	url = $(".leancloud_visitors").attr('id').trim();
	title = $(".leancloud_visitors").attr('data-flag-title').trim();
	var query = new AV.Query(Counter);
	query.equalTo("url", url);
	query.find({
		success: function(results) {
			if (results.length > 0) {
				var counter = results[0];
				counter.fetchWhenSave(true);
				counter.increment("time");
				counter.save(null, {
					success: function(counter) {
						var content = $(document.getElementById(url)).text() + ': ' + counter.get('time');
						$(document.getElementById(url)).text(content);
					},
					error: function(counter, error) {
						console.log('Failed to save Visitor num, with error message: ' + error.message);
					}
				});
			} else {
				var newcounter = new Counter();
				newcounter.set("title", title);
				newcounter.set("url", url);
				newcounter.set("time", 1);
				newcounter.save(null, {
					success: function(newcounter) {
					    console.log("newcounter.get('time')="+newcounter.get('time'));
						var content = $(document.getElementById(url)).text() + ': ' + newcounter.get('time');
						$(document.getElementById(url)).text(content);
					},
					error: function(newcounter, error) {
						console.log('Failed to create');
					}
				});
			}
		},
		error: function(error) {
			console.log('Error:' + error.code + " " + error.message);
		}
	});
}
$(function() {
	var Counter = AV.Object.extend("Counter");
	if ($('.leancloud_visitors').length == 1) {
		addCount(Counter);
	} else if ($('.post-title-link').length > 1) {
		showTime(Counter);
	}
});
</script>
  
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?340874ba9357cbe81570aa4ac1185941";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta custom-logo">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">EZLippi-æµ®ç”Ÿå¿—</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <h1 class="site-subtitle" itemprop="description"></h1>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            å…³äº
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            æœç´¢
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://www.ezlippi.com/blog/2014/07/android-networkOnMainThreadException.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="EZLippi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="EZLippi-æµ®ç”Ÿå¿—">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="EZLippi-æµ®ç”Ÿå¿—" src="/images/avatar.jpg">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                ä»android.os.NetworkOnMainThreadExceptionå¼•å‘çš„æ€è€ƒ
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-07-18T00:00:00+08:00">
                2014-07-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
		  
			 
          
          
             <span id="/blog/2014/07/android-networkOnMainThreadException.html" class="leancloud_visitors" data-flag-title="ä»android.os.NetworkOnMainThreadExceptionå¼•å‘çš„æ€è€ƒ">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">çƒ­åº¦ </span>
               
                 <span class="leancloud-visitors-count"></span>
				 <span>â„ƒ</span>
             </span>
          
		   
          

		  
            <div class="post-wordcount">
              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">å­—æ•°ç»Ÿè®¡</span>
                
                <span title="å­—æ•°ç»Ÿè®¡">
                  4,730
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿</span>
                
                <span title="é˜…è¯»æ—¶é•¿">
                  20
                </span>
              
            </div>
          
		  
          
 
        


        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>æœ€è¿‘åœ¨å†™ä¸€ä¸ªç½‘ç»œé€šä¿¡çš„ç¨‹åºï¼Œè¿è¡Œçš„æ—¶å€™æŠ›å‡ºäº†è¿™æ ·ä¸€ä¸ªå¼‚å¸¸ï¼Œ<code>android.os.NetworkOnMainThreadException</code>ï¼Œæ‰¾äº†å¾ˆä¹…æ²¡å‘ç°åŸå› ï¼Œåæ¥æŸ¥äº†ä¸‹èµ„æ–™æ‰çŸ¥é“æ˜¯androidçš„UIçº¿ç¨‹ä¸èƒ½ç›´æ¥è¿›è¡Œç½‘ç»œè®¿é—®çš„æ“ä½œã€‚<br><a id="more"></a></p>
<h2 id="ä»€ä¹ˆæ˜¯UIçº¿ç¨‹ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯UIçº¿ç¨‹ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯UIçº¿ç¨‹ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯UIçº¿ç¨‹ï¼Ÿ</h2><blockquote>
<p>The concept and importance of the applicationâ€™s main <strong>UI thread</strong> is<br>something every Android developer should understand. Each time an<br>application is launched, the system creates a thread called â€œmainâ€ for<br>the application. The main thread (also known as the â€œUI threadâ€) is in<br>charge of dispatching events to the appropriate views/widgets and thus<br>is very important. Itâ€™s also the thread where your application<br>interacts with running components of your applicationâ€™s UI. For<br>instance, if you touch a button on the screen, the UI thread<br>dispatches the touch event to the view, which then sets its pressed<br>state and posts an invalidate request to the event queue. The UI<br>thread dequeues this request and then tells the view to redraw itself.</p>
<p>This single-thread model can yield poor performance unless Android<br>applications are implemented properly. Specifically, if the UI thread<br>was in charge of running everything in your entire application,<br>performing long operations such as network access or database queries<br>on the UI thread would block the entire user interface. No event would<br>be able to be dispatchedâ€”including drawing and touchscreen<br>eventsâ€”while the long operation is underway. From the userâ€™s<br>perspective, the application will appear to be frozen.</p>
<p>In these situations, instant feedback is vital. Studies show that <strong>0.1</strong><br>seconds is about the limit for having the user feel that the system is<br>reacting instantaneously. Anything slower than this limit will<br>probably be considered as <strong>lag</strong> (Miller 1968; Card et al. 1991). While a<br>fraction of a second might not seem harmful, even a tenth of a second<br>can be the difference between a good review and a bad review on Google<br>Play. Even worse, if the UI thread is blocked for more than about five<br>seconds, the user is presented with the notorious â€œapplication not<br>respondingâ€ (ANR) dialog and the app is force closed.</p>
</blockquote>
<hr>
<h2 id="ä¸ºä»€ä¹ˆä½ çš„App-Crashesï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆä½ çš„App-Crashesï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆä½ çš„App Crashesï¼Ÿ"></a>ä¸ºä»€ä¹ˆä½ çš„App Crashesï¼Ÿ</h2><p>The reason why your application crashes on Android versions 3.0 and above, but works fine on Android 2.x is because Honeycomb and Ice Cream Sandwich are much stricter about abuse against the UI Thread. For example, when an Android device running HoneyComb or above detects a network access on the UI thread, a NetworkOnMainThreadException will be thrown:</p>
<pre><code>E/AndroidRuntime(673): java.lang.RuntimeException: Unable to start activity
    ComponentInfo{com.example/com.example.ExampleActivity}:android.os.NetworkOnMainThreadException
</code></pre><p>åœ¨Android developerç½‘ç«™å¯¹NetworkOnMainThreadExceptionæ˜¯è¿™æ ·è§£é‡Šçš„ï¼š</p>
<blockquote>
<p>A NetworkOnMainThreadException is thrown when an application attempts<br>to perform a networking operation on its main thread. This is only<br>thrown for applications targeting the Honeycomb SDK or higher.<br>Applications targeting earlier SDK versions are allowed to do<br>networking on their main event loop threads, but itâ€™s heavily<br>discouraged.</p>
</blockquote>
<p><strong>å®‰å“3.0ä»¥ä¸Šä¸å…è®¸åœ¨UIçº¿ç¨‹æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</strong></p>
<ol>
<li>æ‰“å¼€ä¸€ä¸ªSocketè¿æ¥(æ¯”å¦‚new Socket()).</li>
<li>HTTPè¯·æ±‚(æ¯”å¦‚HTTPClient and HTTPUrlConnection).</li>
<li>å°è¯•è®¿é—®è¿œç¨‹MySQLæ•°æ®åº“.</li>
<li>ä¸‹è½½æ–‡ä»¶(Downloader.downloadFile()).</li>
</ol>
<p>If you are attempting to perform any of these operations on the UI thread, you must wrap them in a worker thread. The easiest way to do this is to use of an AsyncTask, which allows you to perform asynchronous work on your user interface. An AsyncTask will perform the blocking operations in a worker thread and will publish the results on the UI thread, without requiring you to handle threads and/or handlers yourself.</p>
<h2 id="Android-AsyncTaskå®Œå…¨è§£æ"><a href="#Android-AsyncTaskå®Œå…¨è§£æ" class="headerlink" title="Android AsyncTaskå®Œå…¨è§£æ"></a>Android AsyncTaskå®Œå…¨è§£æ</h2><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒAndroid UIæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå¦‚æœæƒ³è¦åœ¨å­çº¿ç¨‹é‡Œè¿›è¡ŒUIæ“ä½œï¼Œå°±éœ€è¦å€ŸåŠ©Androidçš„å¼‚æ­¥æ¶ˆæ¯å¤„ç†æœºåˆ¶ã€‚</p>
<p>ä¸è¿‡ä¸ºäº†æ›´åŠ æ–¹ä¾¿æˆ‘ä»¬åœ¨å­çº¿ç¨‹ä¸­æ›´æ–°UIå…ƒç´ ï¼ŒAndroidä»1.5ç‰ˆæœ¬å°±å¼•å…¥äº†ä¸€ä¸ªAsyncTaskç±»ï¼Œä½¿ç”¨å®ƒå°±å¯ä»¥éå¸¸çµæ´»æ–¹ä¾¿åœ°ä»å­çº¿ç¨‹åˆ‡æ¢åˆ°UIçº¿ç¨‹ï¼Œæˆ‘ä»¬æœ¬ç¯‡æ–‡ç« çš„ä¸»è§’ä¹Ÿå°±æ­£æ˜¯å®ƒäº†ã€‚</p>
<p>AsyncTaskå¾ˆæ—©å°±å‡ºç°åœ¨Androidçš„APIé‡Œäº†ï¼Œæ‰€ä»¥æˆ‘ç›¸ä¿¡å¤§å¤šæ•°æœ‹å‹å¯¹å®ƒçš„ç”¨æ³•éƒ½å·²ç»éå¸¸ç†Ÿæ‚‰ã€‚ä¸è¿‡ä»Šå¤©æˆ‘è¿˜æ˜¯å‡†å¤‡ä»AsyncTaskçš„åŸºæœ¬ç”¨æ³•å¼€å§‹è®²èµ·ï¼Œç„¶åæˆ‘ä»¬å†æ¥ä¸€èµ·åˆ†æä¸‹AsyncTaskæºç ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼Œæœ€åæˆ‘ä¼šä»‹ç»ä¸€äº›å…³äºAsyncTaskä½ æ‰€ä¸çŸ¥é“çš„ç§˜å¯†ã€‚</p>
<p>AsyncTaskçš„åŸºæœ¬ç”¨æ³•<br>é¦–å…ˆæ¥çœ‹ä¸€ä¸‹AsyncTaskçš„åŸºæœ¬ç”¨æ³•ï¼Œç”±äºAsyncTaskæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³ä½¿ç”¨å®ƒï¼Œå°±å¿…é¡»è¦åˆ›å»ºä¸€ä¸ªå­ç±»å»ç»§æ‰¿å®ƒã€‚åœ¨ç»§æ‰¿æ—¶æˆ‘ä»¬å¯ä»¥ä¸ºAsyncTaskç±»æŒ‡å®šä¸‰ä¸ªæ³›å‹å‚æ•°ï¼Œè¿™ä¸‰ä¸ªå‚æ•°çš„ç”¨é€”å¦‚ä¸‹ï¼š</p>
<ul>
<li>Params</li>
</ul>
<p>åœ¨æ‰§è¡ŒAsyncTaskæ—¶éœ€è¦ä¼ å…¥çš„å‚æ•°ï¼Œå¯ç”¨äºåœ¨åå°ä»»åŠ¡ä¸­ä½¿ç”¨ã€‚</p>
<ul>
<li>Progress</li>
</ul>
<p>åå°ä»»åŠ¡æ‰§è¡Œæ—¶ï¼Œå¦‚æœéœ€è¦åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºå½“å‰çš„è¿›åº¦ï¼Œåˆ™ä½¿ç”¨è¿™é‡ŒæŒ‡å®šçš„æ³›å‹ä½œä¸ºè¿›åº¦å•ä½ã€‚</p>
<ul>
<li>Result</li>
</ul>
<p>å½“ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå¦‚æœéœ€è¦å¯¹ç»“æœè¿›è¡Œè¿”å›ï¼Œåˆ™ä½¿ç”¨è¿™é‡ŒæŒ‡å®šçš„æ³›å‹ä½œä¸ºè¿”å›å€¼ç±»å‹ã€‚</p>
<p>å› æ­¤ï¼Œä¸€ä¸ªæœ€ç®€å•çš„è‡ªå®šä¹‰AsyncTaskå°±å¯ä»¥å†™æˆå¦‚ä¸‹æ–¹å¼ï¼š</p>
<p>[java] </p>
<pre><code>class DownloadTask extends AsyncTask&lt;Void, Integer, Boolean&gt; {  
    â€¦â€¦  
}  
</code></pre><p>è¿™é‡Œæˆ‘ä»¬æŠŠAsyncTaskçš„ç¬¬ä¸€ä¸ªæ³›å‹å‚æ•°æŒ‡å®šä¸ºVoidï¼Œè¡¨ç¤ºåœ¨æ‰§è¡ŒAsyncTaskçš„æ—¶å€™ä¸éœ€è¦ä¼ å…¥å‚æ•°ç»™åå°ä»»åŠ¡ã€‚ç¬¬äºŒä¸ªæ³›å‹å‚æ•°æŒ‡å®šä¸ºIntegerï¼Œè¡¨ç¤ºä½¿ç”¨æ•´å‹æ•°æ®æ¥ä½œä¸ºè¿›åº¦æ˜¾ç¤ºå•ä½ã€‚ç¬¬ä¸‰ä¸ªæ³›å‹å‚æ•°æŒ‡å®šä¸ºBooleanï¼Œåˆ™è¡¨ç¤ºä½¿ç”¨å¸ƒå°”å‹æ•°æ®æ¥åé¦ˆæ‰§è¡Œç»“æœã€‚<br>å½“ç„¶ï¼Œç›®å‰æˆ‘ä»¬è‡ªå®šä¹‰çš„DownloadTaskè¿˜æ˜¯ä¸€ä¸ªç©ºä»»åŠ¡ï¼Œå¹¶ä¸èƒ½è¿›è¡Œä»»ä½•å®é™…çš„æ“ä½œï¼Œæˆ‘ä»¬è¿˜éœ€è¦å»é‡å†™AsyncTaskä¸­çš„å‡ ä¸ªæ–¹æ³•æ‰èƒ½å®Œæˆå¯¹ä»»åŠ¡çš„å®šåˆ¶ã€‚ç»å¸¸éœ€è¦å»é‡å†™çš„æ–¹æ³•æœ‰ä»¥ä¸‹å››ä¸ªï¼š</p>
<ul>
<li>onPreExecute()</li>
</ul>
<p>è¿™ä¸ªæ–¹æ³•ä¼šåœ¨åå°ä»»åŠ¡å¼€å§‹æ‰§è¡Œä¹‹é—´è°ƒç”¨ï¼Œç”¨äºè¿›è¡Œä¸€äº›ç•Œé¢ä¸Šçš„åˆå§‹åŒ–æ“ä½œï¼Œæ¯”å¦‚æ˜¾ç¤ºä¸€ä¸ªè¿›åº¦æ¡å¯¹è¯æ¡†ç­‰ã€‚</p>
<ul>
<li>doInBackground(Paramsâ€¦)</li>
</ul>
<p>è¿™ä¸ªæ–¹æ³•ä¸­çš„æ‰€æœ‰ä»£ç éƒ½ä¼šåœ¨å­çº¿ç¨‹ä¸­è¿è¡Œï¼Œæˆ‘ä»¬åº”è¯¥åœ¨è¿™é‡Œå»å¤„ç†æ‰€æœ‰çš„è€—æ—¶ä»»åŠ¡ã€‚ä»»åŠ¡ä¸€æ—¦å®Œæˆå°±å¯ä»¥é€šè¿‡returnè¯­å¥æ¥å°†ä»»åŠ¡çš„æ‰§è¡Œç»“æœè¿›è¡Œè¿”å›ï¼Œå¦‚æœAsyncTaskçš„ç¬¬ä¸‰ä¸ªæ³›å‹å‚æ•°æŒ‡å®šçš„æ˜¯Voidï¼Œå°±å¯ä»¥ä¸è¿”å›ä»»åŠ¡æ‰§è¡Œç»“æœã€‚æ³¨æ„ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­æ˜¯ä¸å¯ä»¥è¿›è¡ŒUIæ“ä½œçš„ï¼Œå¦‚æœéœ€è¦æ›´æ–°UIå…ƒç´ ï¼Œæ¯”å¦‚è¯´åé¦ˆå½“å‰ä»»åŠ¡çš„æ‰§è¡Œè¿›åº¦ï¼Œå¯ä»¥è°ƒç”¨publishProgress(Progressâ€¦)æ–¹æ³•æ¥å®Œæˆã€‚</p>
<ul>
<li>onProgressUpdate(Progressâ€¦)</li>
</ul>
<p>å½“åœ¨åå°ä»»åŠ¡ä¸­è°ƒç”¨äº†publishProgress(Progressâ€¦)æ–¹æ³•åï¼Œè¿™ä¸ªæ–¹æ³•å°±å¾ˆå¿«ä¼šè¢«è°ƒç”¨ï¼Œæ–¹æ³•ä¸­æºå¸¦çš„å‚æ•°å°±æ˜¯åœ¨åå°ä»»åŠ¡ä¸­ä¼ é€’è¿‡æ¥çš„ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å¯ä»¥å¯¹UIè¿›è¡Œæ“ä½œï¼Œåˆ©ç”¨å‚æ•°ä¸­çš„æ•°å€¼å°±å¯ä»¥å¯¹ç•Œé¢å…ƒç´ è¿›è¡Œç›¸åº”çš„æ›´æ–°ã€‚</p>
<ul>
<li>onPostExecute(Result)</li>
</ul>
<p>å½“åå°ä»»åŠ¡æ‰§è¡Œå®Œæ¯•å¹¶é€šè¿‡returnè¯­å¥è¿›è¡Œè¿”å›æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•å°±å¾ˆå¿«ä¼šè¢«è°ƒç”¨ã€‚è¿”å›çš„æ•°æ®ä¼šä½œä¸ºå‚æ•°ä¼ é€’åˆ°æ­¤æ–¹æ³•ä¸­ï¼Œå¯ä»¥åˆ©ç”¨è¿”å›çš„æ•°æ®æ¥è¿›è¡Œä¸€äº›UIæ“ä½œï¼Œæ¯”å¦‚è¯´æé†’ä»»åŠ¡æ‰§è¡Œçš„ç»“æœï¼Œä»¥åŠå…³é—­æ‰è¿›åº¦æ¡å¯¹è¯æ¡†ç­‰ã€‚</p>
<p>å› æ­¤ï¼Œä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„è‡ªå®šä¹‰AsyncTaskå°±å¯ä»¥å†™æˆå¦‚ä¸‹æ–¹å¼ï¼š</p>
<p>[java] </p>
<pre><code>class DownloadTask extends AsyncTask&lt;Void, Integer, Boolean&gt; {  

    @Override  
protected void onPreExecute() {  
    progressDialog.show();  
}  

@Override  
protected Boolean doInBackground(Void... params) {  
    try {  
        while (true) {  
            int downloadPercent = doDownload();  
            publishProgress(downloadPercent);  
            if (downloadPercent &gt;= 100) {  
                break;  
            }  
        }  
    } catch (Exception e) {  
        return false;  
    }  
    return true;  
}  

@Override  
protected void onProgressUpdate(Integer... values) {  
    progressDialog.setMessage(&quot;å½“å‰ä¸‹è½½è¿›åº¦ï¼š&quot; + values[0] + &quot;%&quot;);  
}  

@Override  
protected void onPostExecute(Boolean result) {  
    progressDialog.dismiss();  
    if (result) {  
        Toast.makeText(context, &quot;ä¸‹è½½æˆåŠŸ&quot;, Toast.LENGTH_SHORT).show();  
    } else {  
        Toast.makeText(context, &quot;ä¸‹è½½å¤±è´¥&quot;, Toast.LENGTH_SHORT).show();  
    }  
}  
</code></pre><p>}<br>è¿™é‡Œæˆ‘ä»¬æ¨¡æ‹Ÿäº†ä¸€ä¸ªä¸‹è½½ä»»åŠ¡ï¼Œåœ¨doInBackground()æ–¹æ³•ä¸­å»æ‰§è¡Œå…·ä½“çš„ä¸‹è½½é€»è¾‘ï¼Œåœ¨onProgressUpdate()æ–¹æ³•ä¸­æ˜¾ç¤ºå½“å‰çš„ä¸‹è½½è¿›åº¦ï¼Œåœ¨onPostExecute()æ–¹æ³•ä¸­æ¥æç¤ºä»»åŠ¡çš„æ‰§è¡Œç»“æœã€‚å¦‚æœæƒ³è¦å¯åŠ¨è¿™ä¸ªä»»åŠ¡ï¼Œåªéœ€è¦ç®€å•åœ°è°ƒç”¨ä»¥ä¸‹ä»£ç å³å¯ï¼š<br>[java] </p>
<pre><code>new DownloadTask().execute();  
</code></pre><p>ä»¥ä¸Šå°±æ˜¯AsyncTaskçš„åŸºæœ¬ç”¨æ³•ï¼Œæ€ä¹ˆæ ·ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰åœ¨å­çº¿ç¨‹å’ŒUIçº¿ç¨‹ä¹‹é—´è¿›è¡Œåˆ‡æ¢å˜å¾—çµæ´»äº†å¾ˆå¤šï¼Ÿæˆ‘ä»¬å¹¶ä¸éœ€æ±‚å»è€ƒè™‘ä»€ä¹ˆå¼‚æ­¥æ¶ˆæ¯å¤„ç†æœºåˆ¶ï¼Œä¹Ÿä¸éœ€è¦ä¸“é—¨ä½¿ç”¨ä¸€ä¸ªHandleræ¥å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ï¼Œåªéœ€è¦è°ƒç”¨ä¸€ä¸‹publishProgress()æ–¹æ³•å°±å¯ä»¥è½»æ¾åœ°ä»å­çº¿ç¨‹åˆ‡æ¢åˆ°UIçº¿ç¨‹äº†ã€‚<br>åˆ†æAsyncTaskçš„æºç <br>è™½ç„¶AsyncTaskè¿™ä¹ˆç®€å•å¥½ç”¨ï¼Œä½†ä½ çŸ¥é“å®ƒæ˜¯æ€æ ·å®ç°çš„å—ï¼Ÿé‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥åˆ†æä¸€ä¸‹AsyncTaskçš„æºç ï¼Œå¯¹å®ƒçš„å®ç°åŸç†ä¸€æ¢ç©¶ç«Ÿã€‚æ³¨æ„è¿™é‡Œæˆ‘é€‰ç”¨çš„æ˜¯Android 4.0çš„æºç ï¼Œå¦‚æœä½ æŸ¥çœ‹çš„æ˜¯å…¶å®ƒç‰ˆæœ¬çš„æºç ï¼Œå¯èƒ½ä¼šæœ‰ä¸€äº›å‡ºå…¥ã€‚</p>
<p>ä»ä¹‹å‰DownloadTaskçš„ä»£ç å°±å¯ä»¥çœ‹å‡ºï¼Œåœ¨å¯åŠ¨æŸä¸€ä¸ªä»»åŠ¡ä¹‹å‰ï¼Œè¦å…ˆnewå‡ºå®ƒçš„å®ä¾‹ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å°±å…ˆæ¥çœ‹ä¸€çœ‹AsyncTaskæ„é€ å‡½æ•°ä¸­çš„æºç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p>[java] </p>
<pre><code>public AsyncTask() {  
    mWorker = new WorkerRunnable&lt;Params, Result&gt;() {  
        public Result call() throws Exception {  
            mTaskInvoked.set(true);  
            Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);  
            return postResult(doInBackground(mParams));  
        }  
    };  
    mFuture = new FutureTask&lt;Result&gt;(mWorker) {  
        @Override  
        protected void done() {  
            try {  
                final Result result = get();  
                postResultIfNotInvoked(result);  
            } catch (InterruptedException e) {  
                android.util.Log.w(LOG_TAG, e);  
            } catch (ExecutionException e) {  
                throw new RuntimeException(&quot;An error occured while executing doInBackground()&quot;,  
                        e.getCause());  
            } catch (CancellationException e) {  
                postResultIfNotInvoked(null);  
            } catch (Throwable t) {  
                throw new RuntimeException(&quot;An error occured while executing &quot;  
                        + &quot;doInBackground()&quot;, t);  
            }  
        }  
    };  
}  
</code></pre><p>è¿™æ®µä»£ç è™½ç„¶çœ‹èµ·æ¥æœ‰ç‚¹é•¿ï¼Œä½†å®é™…ä¸Šå¹¶æ²¡æœ‰ä»»ä½•å…·ä½“çš„é€»è¾‘ä¼šå¾—åˆ°æ‰§è¡Œï¼Œåªæ˜¯åˆå§‹åŒ–äº†ä¸¤ä¸ªå˜é‡ï¼ŒmWorkerå’ŒmFutureï¼Œå¹¶åœ¨åˆå§‹åŒ–mFutureçš„æ—¶å€™å°†mWorkerä½œä¸ºå‚æ•°ä¼ å…¥ã€‚mWorkeræ˜¯ä¸€ä¸ªCallableå¯¹è±¡ï¼ŒmFutureæ˜¯ä¸€ä¸ªFutureTaskå¯¹è±¡ï¼Œè¿™ä¸¤ä¸ªå˜é‡ä¼šæš‚æ—¶ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œç¨åæ‰ä¼šç”¨åˆ°å®ƒä»¬ã€‚<br>æ¥ç€å¦‚æœæƒ³è¦å¯åŠ¨æŸä¸€ä¸ªä»»åŠ¡ï¼Œå°±éœ€è¦è°ƒç”¨è¯¥ä»»åŠ¡çš„execute()æ–¹æ³•ï¼Œå› æ­¤ç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹execute()æ–¹æ³•çš„æºç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p>[java] </p>
<pre><code>public final AsyncTask&lt;Params, Progress, Result&gt; execute(Params... params) {  
    return executeOnExecutor(sDefaultExecutor, params);  
}  
</code></pre><p>ç®€å•çš„æœ‰ç‚¹è¿‡åˆ†äº†ï¼Œåªæœ‰ä¸€è¡Œä»£ç ï¼Œä»…æ˜¯è°ƒç”¨äº†executeOnExecutor()æ–¹æ³•ï¼Œé‚£ä¹ˆå…·ä½“çš„é€»è¾‘å°±åº”è¯¥å†™åœ¨è¿™ä¸ªæ–¹æ³•é‡Œäº†ï¼Œå¿«è·Ÿè¿›å»ç§ä¸€ç§ï¼š<br>[java]</p>
<pre><code>public final AsyncTask&lt;Params, Progress, Result&gt; executeOnExecutor(Executor exec,  
        Params... params) {  
    if (mStatus != Status.PENDING) {  
        switch (mStatus) {  
            case RUNNING:  
                throw new IllegalStateException(&quot;Cannot execute task:&quot;  
                        + &quot; the task is already running.&quot;);  
            case FINISHED:  
                throw new IllegalStateException(&quot;Cannot execute task:&quot;  
                        + &quot; the task has already been executed &quot;  
                        + &quot;(a task can be executed only once)&quot;);  
        }  
    }  
    mStatus = Status.RUNNING;  
    onPreExecute();  
    mWorker.mParams = params;  
    exec.execute(mFuture);  
    return this;  
}  
</code></pre><p>æœç„¶ï¼Œè¿™é‡Œçš„ä»£ç çœ‹ä¸Šå»æ‰æ­£å¸¸ç‚¹ã€‚å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ç¬¬15è¡Œè°ƒç”¨äº†onPreExecute()æ–¹æ³•ï¼Œå› æ­¤è¯æ˜äº†onPreExecute()æ–¹æ³•ä¼šç¬¬ä¸€ä¸ªå¾—åˆ°æ‰§è¡Œã€‚å¯æ˜¯æ¥ä¸‹æ¥çš„ä»£ç å°±çœ‹ä¸æ˜ç™½äº†ï¼Œæ€ä¹ˆæ²¡è§åˆ°å“ªé‡Œæœ‰è°ƒç”¨doInBackground()æ–¹æ³•å‘¢ï¼Ÿåˆ«ç€æ€¥ï¼Œæ…¢æ…¢æ‰¾æ€»ä¼šæ‰¾åˆ°çš„ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨ç¬¬17è¡Œè°ƒç”¨äº†Executorçš„execute()æ–¹æ³•ï¼Œå¹¶å°†å‰é¢åˆå§‹åŒ–çš„mFutureå¯¹è±¡ä¼ äº†è¿›å»ï¼Œé‚£ä¹ˆè¿™ä¸ªExecutorå¯¹è±¡åˆæ˜¯ä»€ä¹ˆå‘¢ï¼ŸæŸ¥çœ‹ä¸Šé¢çš„execute()æ–¹æ³•ï¼ŒåŸæ¥æ˜¯ä¼ å…¥äº†ä¸€ä¸ªsDefaultExecutorå˜é‡ï¼Œæ¥ç€æ‰¾ä¸€ä¸‹è¿™ä¸ªsDefaultExecutorå˜é‡æ˜¯åœ¨å“ªé‡Œå®šä¹‰çš„ï¼Œæºç å¦‚ä¸‹æ‰€ç¤ºï¼š<br>[java]</p>
<pre><code>public static final Executor SERIAL_EXECUTOR = new SerialExecutor();  
â€¦â€¦  
private static volatile Executor sDefaultExecutor = SERIAL_EXECUTOR;  
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå…ˆnewå‡ºäº†ä¸€ä¸ªSERIAL_EXECUTORå¸¸é‡ï¼Œç„¶åå°†sDefaultExecutorçš„å€¼èµ‹å€¼ä¸ºè¿™ä¸ªå¸¸é‡ï¼Œä¹Ÿå°±æ˜¯è¯´æ˜ï¼Œåˆšæ‰åœ¨executeOnExecutor()æ–¹æ³•ä¸­è°ƒç”¨çš„execute()æ–¹æ³•ï¼Œå…¶å®ä¹Ÿå°±æ˜¯è°ƒç”¨çš„SerialExecutorç±»ä¸­çš„execute()æ–¹æ³•ã€‚é‚£ä¹ˆæˆ‘ä»¬è‡ªç„¶è¦å»çœ‹çœ‹SerialExecutorçš„æºç äº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br>[java] </p>
<pre><code>private static class SerialExecutor implements Executor {  
    final ArrayDeque&lt;Runnable&gt; mTasks = new ArrayDeque&lt;Runnable&gt;();  
    Runnable mActive;  

    public synchronized void execute(final Runnable r) {  
        mTasks.offer(new Runnable() {  
            public void run() {  
                try {  
                    r.run();  
                } finally {  
                    scheduleNext();  
                }  
            }  
        });  
        if (mActive == null) {  
            scheduleNext();  
        }  
    }  

    protected synchronized void scheduleNext() {  
        if ((mActive = mTasks.poll()) != null) {  
            THREAD_POOL_EXECUTOR.execute(mActive);  
        }  
    }  
}  
</code></pre><p>SerialExecutorç±»ä¸­ä¹Ÿæœ‰ä¸€ä¸ªexecute()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œçš„æ‰€æœ‰é€»è¾‘å°±æ˜¯åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œçš„äº†ï¼Œæ³¨æ„è¿™ä¸ªæ–¹æ³•æœ‰ä¸€ä¸ªRunnableå‚æ•°ï¼Œé‚£ä¹ˆç›®å‰è¿™ä¸ªå‚æ•°çš„å€¼æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå½“ç„¶å°±æ˜¯mFutureå¯¹è±¡äº†ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ç¬¬9è¡Œæˆ‘ä»¬è¦è°ƒç”¨çš„æ˜¯FutureTaskç±»çš„run()æ–¹æ³•ï¼Œè€Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œåˆä¼šå»è°ƒç”¨Syncå†…éƒ¨ç±»çš„innerRun()æ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬ç›´æ¥æ¥çœ‹innerRun()æ–¹æ³•çš„æºç ï¼š<br>[java] </p>
<pre><code>void innerRun() {  
    if (!compareAndSetState(READY, RUNNING))  
        return;  
    runner = Thread.currentThread();  
    if (getState() == RUNNING) { // recheck after setting thread  
        V result;  
        try {  
            result = callable.call();  
        } catch (Throwable ex) {  
            setException(ex);  
            return;  
        }  
        set(result);  
    } else {  
        releaseShared(0); // cancel  
    }  
} 
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ç¬¬8è¡Œè°ƒç”¨äº†callableçš„call()æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªcallableå¯¹è±¡æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå…¶å®å°±æ˜¯åœ¨åˆå§‹åŒ–mFutureå¯¹è±¡æ—¶ä¼ å…¥çš„mWorkerå¯¹è±¡äº†ï¼Œæ­¤æ—¶è°ƒç”¨çš„call()æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ä¸€å¼€å§‹åœ¨AsyncTaskçš„æ„é€ å‡½æ•°ä¸­æŒ‡å®šçš„ï¼Œæˆ‘ä»¬æŠŠå®ƒå•ç‹¬æ‹¿å‡ºæ¥çœ‹ä¸€ä¸‹ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š<br>[java]</p>
<pre><code>public Result call() throws Exception {  
    mTaskInvoked.set(true);  
    Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);  
    return postResult(doInBackground(mParams));  
} 
</code></pre><p>åœ¨postResult()æ–¹æ³•çš„å‚æ•°é‡Œé¢ï¼Œæˆ‘ä»¬ç»ˆäºæ‰¾åˆ°äº†doInBackground()æ–¹æ³•çš„è°ƒç”¨å¤„ï¼Œè™½ç„¶ç»è¿‡äº†å¾ˆå¤šå‘¨è½¬ï¼Œä½†ç›®å‰çš„ä»£ç ä»ç„¶æ˜¯è¿è¡Œåœ¨å­çº¿ç¨‹å½“ä¸­çš„ï¼Œæ‰€ä»¥è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨doInBackground()æ–¹æ³•ä¸­å»å¤„ç†è€—æ—¶çš„é€»è¾‘ã€‚æ¥ç€å°†doInBackground()æ–¹æ³•è¿”å›çš„ç»“æœä¼ é€’ç»™äº†postResult()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„æºç å¦‚ä¸‹æ‰€ç¤ºï¼š<br>[java] </p>
<pre><code>private Result postResult(Result result) {  
    Message message = sHandler.obtainMessage(MESSAGE_POST_RESULT,  
            new AsyncTaskResult&lt;Result&gt;(this, result));  
    message.sendToTarget();  
    return result;  
} 
</code></pre><p>å¦‚æœä½ å·²ç»ç†Ÿæ‚‰äº†å¼‚æ­¥æ¶ˆæ¯å¤„ç†æœºåˆ¶ï¼Œè¿™æ®µä»£ç å¯¹ä½ æ¥è¯´ä¸€å®šéå¸¸ç®€å•å§ã€‚è¿™é‡Œä½¿ç”¨sHandlerå¯¹è±¡å‘å‡ºäº†ä¸€æ¡æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¸­æºå¸¦äº†MESSAGE_POST_RESULTå¸¸é‡å’Œä¸€ä¸ªè¡¨ç¤ºä»»åŠ¡æ‰§è¡Œç»“æœçš„AsyncTaskResultå¯¹è±¡ã€‚è¿™ä¸ªsHandlerå¯¹è±¡æ˜¯InternalHandlerç±»çš„ä¸€ä¸ªå®ä¾‹ï¼Œé‚£ä¹ˆç¨åè¿™æ¡æ¶ˆæ¯è‚¯å®šä¼šåœ¨InternalHandlerçš„handleMessage()æ–¹æ³•ä¸­è¢«å¤„ç†ã€‚InternalHandlerçš„æºç å¦‚ä¸‹æ‰€ç¤ºï¼š<br>[java] </p>
<pre><code>private static class InternalHandler extends Handler {  
    @SuppressWarnings({&quot;unchecked&quot;, &quot;RawUseOfParameterizedType&quot;})  
    @Override  
    public void handleMessage(Message msg) {  
        AsyncTaskResult result = (AsyncTaskResult) msg.obj;  
        switch (msg.what) {  
            case MESSAGE_POST_RESULT:  
                // There is only one result  
                result.mTask.finish(result.mData[0]);  
                break;  
            case MESSAGE_POST_PROGRESS:  
                result.mTask.onProgressUpdate(result.mData);  
                break;  
        }  
    }  
}
</code></pre><p>è¿™é‡Œå¯¹æ¶ˆæ¯çš„ç±»å‹è¿›è¡Œäº†åˆ¤æ–­ï¼Œå¦‚æœè¿™æ˜¯ä¸€æ¡MESSAGE_POST_RESULTæ¶ˆæ¯ï¼Œå°±ä¼šå»æ‰§è¡Œfinish()æ–¹æ³•ï¼Œå¦‚æœè¿™æ˜¯ä¸€æ¡MESSAGE_POST_PROGRESSæ¶ˆæ¯ï¼Œå°±ä¼šå»æ‰§è¡ŒonProgressUpdate()æ–¹æ³•ã€‚é‚£ä¹ˆfinish()æ–¹æ³•çš„æºç å¦‚ä¸‹æ‰€ç¤ºï¼š<br>[java] </p>
<pre><code>private void finish(Result result) {  
    if (isCancelled()) {  
        onCancelled(result);  
    } else {  
        onPostExecute(result);  
    }  
    mStatus = Status.FINISHED;  
}  
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœå½“å‰ä»»åŠ¡è¢«å–æ¶ˆæ‰äº†ï¼Œå°±ä¼šè°ƒç”¨onCancelled()æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰è¢«å–æ¶ˆï¼Œåˆ™è°ƒç”¨onPostExecute()æ–¹æ³•ï¼Œè¿™æ ·å½“å‰ä»»åŠ¡çš„æ‰§è¡Œå°±å…¨éƒ¨ç»“æŸäº†ã€‚<br>æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œåœ¨åˆšæ‰InternalHandlerçš„handleMessage()æ–¹æ³•é‡Œï¼Œè¿˜æœ‰ä¸€ç§MESSAGE_POST_PROGRESSçš„æ¶ˆæ¯ç±»å‹ï¼Œè¿™ç§æ¶ˆæ¯æ˜¯ç”¨äºå½“å‰è¿›åº¦çš„ï¼Œè°ƒç”¨çš„æ­£æ˜¯onProgressUpdate()æ–¹æ³•ï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™æ‰ä¼šå‘å‡ºè¿™æ ·ä¸€æ¡æ¶ˆæ¯å‘¢ï¼Ÿç›¸ä¿¡ä½ å·²ç»çŒœåˆ°äº†ï¼ŒæŸ¥çœ‹publishProgress()æ–¹æ³•çš„æºç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p>[java] </p>
<pre><code>protected final void publishProgress(Progress... values) {  
    if (!isCancelled()) {  
        sHandler.obtainMessage(MESSAGE_POST_PROGRESS,  
                new AsyncTaskResult&lt;Progress&gt;(this, values)).sendToTarget();  
    }  
}
</code></pre><p>éå¸¸æ¸…æ™°äº†å§ï¼æ­£å› å¦‚æ­¤ï¼Œåœ¨doInBackground()æ–¹æ³•ä¸­è°ƒç”¨publishProgress()æ–¹æ³•æ‰å¯ä»¥ä»å­çº¿ç¨‹åˆ‡æ¢åˆ°UIçº¿ç¨‹ï¼Œä»è€Œå®Œæˆå¯¹UIå…ƒç´ çš„æ›´æ–°æ“ä½œã€‚å…¶å®ä¹Ÿæ²¡æœ‰ä»€ä¹ˆç¥ç§˜çš„ï¼Œå› ä¸ºè¯´åˆ°åº•ï¼ŒAsyncTaskä¹Ÿæ˜¯ä½¿ç”¨çš„å¼‚æ­¥æ¶ˆæ¯å¤„ç†æœºåˆ¶ï¼Œåªæ˜¯åšäº†éå¸¸å¥½çš„å°è£…è€Œå·²ã€‚<br>è¯»åˆ°è¿™é‡Œï¼Œç›¸ä¿¡ä½ å¯¹AsyncTaskä¸­çš„æ¯ä¸ªå›è°ƒæ–¹æ³•çš„ä½œç”¨ã€åŸç†ã€ä»¥åŠä½•æ—¶ä¼šè¢«è°ƒç”¨éƒ½å·²ç»ææ˜ç™½äº†å§ã€‚</p>
<p><strong>å…³äºAsyncTaskä½ æ‰€ä¸çŸ¥é“çš„ç§˜å¯†</strong><br>ä¸å¾—ä¸è¯´ï¼Œåˆšæ‰æˆ‘ä»¬åœ¨åˆ†æSerialExecutorçš„æ—¶å€™ï¼Œå…¶å®å¹¶æ²¡æœ‰åˆ†æçš„å¾ˆä»”ç»†ï¼Œä»…ä»…åªæ˜¯å…³æ³¨äº†å®ƒä¼šè°ƒç”¨mFutureä¸­çš„run()æ–¹æ³•ï¼Œä½†æ˜¯è‡³äºä»€ä¹ˆæ—¶å€™ä¼šè°ƒç”¨æˆ‘ä»¬å¹¶æ²¡æœ‰è¿›ä¸€æ­¥åœ°ç ”ç©¶ã€‚å…¶å®SerialExecutorä¹Ÿæ˜¯AsyncTaskåœ¨3.0ç‰ˆæœ¬ä»¥ååšäº†æœ€ä¸»è¦çš„ä¿®æ”¹çš„åœ°æ–¹ï¼Œå®ƒåœ¨AsyncTaskä¸­æ˜¯ä»¥å¸¸é‡çš„å½¢å¼è¢«ä½¿ç”¨çš„ï¼Œå› æ­¤åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰AsyncTaskå®ä¾‹éƒ½ä¼šå…±ç”¨åŒä¸€ä¸ªSerialExecutorã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥å¯¹è¿™ä¸ªç±»è¿›è¡Œæ›´åŠ è¯¦ç»†çš„åˆ†æï¼Œä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œæˆ‘æŠŠå®ƒçš„ä»£ç å†è´´å‡ºæ¥ä¸€éï¼š</p>
<p>[java] </p>
<pre><code>private static class SerialExecutor implements Executor {  
    final ArrayDeque&lt;Runnable&gt; mTasks = new ArrayDeque&lt;Runnable&gt;();  
    Runnable mActive;  

    public synchronized void execute(final Runnable r) {  
        mTasks.offer(new Runnable() {  
            public void run() {  
                try {  
                    r.run();  
                } finally {  
                    scheduleNext();  
                }  
            }  
        });  
        if (mActive == null) {  
            scheduleNext();  
        }  
    }  

    protected synchronized void scheduleNext() {  
        if ((mActive = mTasks.poll()) != null) {  
            THREAD_POOL_EXECUTOR.execute(mActive);  
        }  
    }  
} 
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼ŒSerialExecutoræ˜¯ä½¿ç”¨ArrayDequeè¿™ä¸ªé˜Ÿåˆ—æ¥ç®¡ç†Runnableå¯¹è±¡çš„ï¼Œå¦‚æœæˆ‘ä»¬ä¸€æ¬¡æ€§å¯åŠ¨äº†å¾ˆå¤šä¸ªä»»åŠ¡ï¼Œé¦–å…ˆåœ¨ç¬¬ä¸€æ¬¡è¿è¡Œexecute()æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨ArrayDequeçš„offer()æ–¹æ³•å°†ä¼ å…¥çš„Runnableå¯¹è±¡æ·»åŠ åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œç„¶ååˆ¤æ–­mActiveå¯¹è±¡æ˜¯ä¸æ˜¯ç­‰äºnullï¼Œç¬¬ä¸€æ¬¡è¿è¡Œå½“ç„¶æ˜¯ç­‰äºnulläº†ï¼Œäºæ˜¯ä¼šè°ƒç”¨scheduleNext()æ–¹æ³•ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä¼šä»é˜Ÿåˆ—çš„å¤´éƒ¨å–å€¼ï¼Œå¹¶èµ‹å€¼ç»™mActiveå¯¹è±¡ï¼Œç„¶åè°ƒç”¨THREAD_POOL_EXECUTORå»æ‰§è¡Œå–å‡ºçš„å–å‡ºçš„Runnableå¯¹è±¡ã€‚ä¹‹åå¦‚ä½•åˆæœ‰æ–°çš„ä»»åŠ¡è¢«æ‰§è¡Œï¼ŒåŒæ ·è¿˜ä¼šè°ƒç”¨offer()æ–¹æ³•å°†ä¼ å…¥çš„Runnableæ·»åŠ åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œä½†æ˜¯å†å»ç»™mActiveå¯¹è±¡åšéç©ºæ£€æŸ¥çš„æ—¶å€™å°±ä¼šå‘ç°mActiveå¯¹è±¡å·²ç»ä¸å†æ˜¯nulläº†ï¼Œäºæ˜¯å°±ä¸ä¼šå†è°ƒç”¨scheduleNext()æ–¹æ³•ã€‚<br>é‚£ä¹ˆåé¢æ·»åŠ çš„ä»»åŠ¡å²‚ä¸æ˜¯æ°¸è¿œå¾—ä¸åˆ°å¤„ç†äº†ï¼Ÿå½“ç„¶ä¸æ˜¯ï¼Œçœ‹ä¸€çœ‹offer()æ–¹æ³•é‡Œä¼ å…¥çš„RunnableåŒ¿åç±»ï¼Œè¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªtry finallyä»£ç å—ï¼Œå¹¶åœ¨finallyä¸­è°ƒç”¨äº†scheduleNext()æ–¹æ³•ï¼Œä¿è¯æ— è®ºå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Œè¿™ä¸ªæ–¹æ³•éƒ½ä¼šè¢«è°ƒç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯æ¬¡å½“ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œä¸‹ä¸€ä¸ªä»»åŠ¡æ‰ä¼šå¾—åˆ°æ‰§è¡Œï¼ŒSerialExecutoræ¨¡ä»¿çš„æ˜¯å•ä¸€çº¿ç¨‹æ± çš„æ•ˆæœï¼Œå¦‚æœæˆ‘ä»¬å¿«é€Ÿåœ°å¯åŠ¨äº†å¾ˆå¤šä»»åŠ¡ï¼ŒåŒä¸€æ—¶åˆ»åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œï¼Œå…¶ä½™çš„å‡å¤„äºç­‰å¾…çŠ¶æ€ã€‚Androidç…§ç‰‡å¢™åº”ç”¨å®ç°ï¼Œå†å¤šçš„å›¾ç‰‡ä¹Ÿä¸æ€•å´©æºƒ è¿™ç¯‡æ–‡ç« ä¸­ä¾‹å­çš„è¿è¡Œç»“æœä¹Ÿè¯å®äº†è¿™ä¸ªç»“è®ºã€‚</p>
<p>ä¸è¿‡ä½ å¯èƒ½è¿˜ä¸çŸ¥é“ï¼Œåœ¨Android 3.0ä¹‹å‰æ˜¯å¹¶æ²¡æœ‰SerialExecutorè¿™ä¸ªç±»çš„ï¼Œé‚£ä¸ªæ—¶å€™æ˜¯ç›´æ¥åœ¨AsyncTaskä¸­æ„å»ºäº†ä¸€ä¸ªsExecutorå¸¸é‡ï¼Œå¹¶å¯¹çº¿ç¨‹æ± æ€»å¤§å°ï¼ŒåŒä¸€æ—¶åˆ»èƒ½å¤Ÿè¿è¡Œçš„çº¿ç¨‹æ•°åšäº†è§„å®šï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p>[java] </p>
<pre><code>private static final int CORE_POOL_SIZE = 5;  
private static final int MAXIMUM_POOL_SIZE = 128;  
private static final int KEEP_ALIVE = 10;  
â€¦â€¦  
private static final ThreadPoolExecutor sExecutor = new ThreadPoolExecutor(CORE_POOL_SIZE,  
        MAXIMUM_POOL_SIZE, KEEP_ALIVE, TimeUnit.SECONDS, sWorkQueue, sThreadFactory);  
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œè§„å®šåŒä¸€æ—¶åˆ»èƒ½å¤Ÿè¿è¡Œçš„çº¿ç¨‹æ•°ä¸º5ä¸ªï¼Œçº¿ç¨‹æ± æ€»å¤§å°ä¸º128ã€‚ä¹Ÿå°±æ˜¯è¯´å½“æˆ‘ä»¬å¯åŠ¨äº†10ä¸ªä»»åŠ¡æ—¶ï¼Œåªæœ‰5ä¸ªä»»åŠ¡èƒ½å¤Ÿç«‹åˆ»æ‰§è¡Œï¼Œå¦å¤–çš„5ä¸ªä»»åŠ¡åˆ™éœ€è¦ç­‰å¾…ï¼Œå½“æœ‰ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œç¬¬6ä¸ªä»»åŠ¡æ‰ä¼šå¯åŠ¨ï¼Œä»¥æ­¤ç±»æ¨ã€‚è€Œçº¿ç¨‹æ± ä¸­æœ€å¤§èƒ½å­˜æ”¾çš„çº¿ç¨‹æ•°æ˜¯128ä¸ªï¼Œå½“æˆ‘ä»¬å°è¯•å»æ·»åŠ ç¬¬129ä¸ªä»»åŠ¡æ—¶ï¼Œç¨‹åºå°±ä¼šå´©æºƒã€‚<br>å› æ­¤åœ¨3.0ç‰ˆæœ¬ä¸­AsyncTaskçš„æ”¹åŠ¨è¿˜æ˜¯æŒºå¤§çš„ï¼Œåœ¨3.0ä¹‹å‰çš„AsyncTaskå¯ä»¥åŒæ—¶æœ‰5ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œï¼Œè€Œ3.0ä¹‹åçš„AsyncTaskåŒæ—¶åªèƒ½æœ‰1ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œã€‚ä¸ºä»€ä¹ˆå‡çº§ä¹‹åå¯ä»¥åŒæ—¶æ‰§è¡Œçš„ä»»åŠ¡æ•°åè€Œå˜å°‘äº†å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºæ›´æ–°åçš„AsyncTaskå·²å˜å¾—æ›´åŠ çµæ´»ï¼Œå¦‚æœä¸æƒ³ä½¿ç”¨é»˜è®¤çš„çº¿ç¨‹æ± ï¼Œè¿˜å¯ä»¥è‡ªç”±åœ°è¿›è¡Œé…ç½®ã€‚æ¯”å¦‚ä½¿ç”¨å¦‚ä¸‹çš„ä»£ç æ¥å¯åŠ¨ä»»åŠ¡ï¼š</p>
<p>[java] </p>
<pre><code>Executor exec = new ThreadPoolExecutor(15, 200, 10,  
        TimeUnit.SECONDS, new LinkedBlockingQueue&lt;Runnable&gt;());  
new DownloadTask().executeOnExecutor(exec); 
</code></pre><p>è¿™æ ·å°±å¯ä»¥ä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„ä¸€ä¸ªExecutoræ¥æ‰§è¡Œä»»åŠ¡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨SerialExecutorã€‚ä¸Šè¿°ä»£ç çš„æ•ˆæœå…è®¸åœ¨åŒä¸€æ—¶åˆ»æœ‰15ä¸ªä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œå¹¶ä¸”æœ€å¤šèƒ½å¤Ÿå­˜å‚¨200ä¸ªä»»åŠ¡ã€‚<br>å¥½äº†ï¼Œåˆ°è¿™é‡Œæˆ‘ä»¬å°±å·²ç»æŠŠå…³äºAsyncTaskçš„æ‰€æœ‰é‡è¦å†…å®¹æ·±å…¥æµ…å‡ºåœ°ç†è§£äº†ä¸€éï¼Œç›¸ä¿¡åœ¨å°†æ¥ä½¿ç”¨å®ƒçš„æ—¶å€™èƒ½å¤Ÿæ›´åŠ å¾—å¿ƒåº”æ‰‹ã€‚</p>
<p>å‚è€ƒï¼š</p>
<ol>
<li><a href="http://www.androiddesignpatterns.com/2012/06/app-force-close-honeycomb-ics.html" target="_blank" rel="external">Why Ice Cream Sandwich Crashes your App</a></li>
<li><a href="http://developer.android.com/reference/android/os/AsyncTask.html" target="_blank" rel="external">AsyncTask</a></li>
<li><a href="http://android-developers.blogspot.com/2010/07/multithreading-for-performance.html" target="_blank" rel="external">Multithreading For Performance</a></li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>
  
        <div class="post-tags">
          
            <a href="/tags/java/" rel="tag"># java</a>
          
            <a href="/tags/android/" rel="tag"># android</a>
          
        </div>
      


    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>ğŸ¶ æ‚¨çš„æ”¯æŒå°†é¼“åŠ±æˆ‘ç»§ç»­åˆ›ä½œ ğŸ¶</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>èµèµ</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/images/wechat-reward-img.jpg" alt="EZLippi WeChat Pay"/>
          <p>å¾®ä¿¡æ‰“èµ</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/images/alipay-reward-img.jpg" alt="EZLippi Alipay"/>
          <p>æ”¯ä»˜å®æ‰“èµ</p>
        </div>
      
    </div>
  </div>


      
    </div>


    <footer class="post-footer">
        
     <div>    
      
      <ul class="post-copyright">
         <li class="post-copyright-link">
          <strong>æœ¬æ–‡ä½œè€…ï¼š</strong>
          <a href="/" title="æ¬¢è¿è®¿é—® EZLippi çš„ä¸ªäººåšå®¢">EZLippi</a>
        </li>

        <li class="post-copyright-link">
          <strong>æœ¬æ–‡æ ‡é¢˜ï¼š</strong>
          <a href="http://www.ezlippi.com/blog/2014/07/android-networkOnMainThreadException.html" title="ä»android.os.NetworkOnMainThreadExceptionå¼•å‘çš„æ€è€ƒ">ä»android.os.NetworkOnMainThreadExceptionå¼•å‘çš„æ€è€ƒ</a>
        </li>

        <li class="post-copyright-link">
          <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
          <a href="http://www.ezlippi.com/blog/2014/07/android-networkOnMainThreadException.html" title="ä»android.os.NetworkOnMainThreadExceptionå¼•å‘çš„æ€è€ƒ">http://www.ezlippi.com/blog/2014/07/android-networkOnMainThreadException.html</a>
        </li>

        <li class="post-copyright-date">
            <strong>å‘å¸ƒæ—¶é—´ï¼š</strong>2014å¹´7æœˆ18æ—¥ - 00æ—¶07åˆ†
        </li>  

        <li class="post-copyright-license">
          <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>
          æœ¬æ–‡ç”± EZLippi åŸåˆ›ï¼Œé‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" rel="license" target="_blank">ä¿ç•™ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0-å›½é™…è®¸å¯åè®®</a> </br>è½¬è½½è¯·ä¿ç•™ä»¥ä¸Šå£°æ˜ä¿¡æ¯ï¼
        </li>
      </ul>
    
  </div>  
      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/2014/07/use-jekyll-build-blog-on-github.html" rel="next" title="ä½¿ç”¨jekyllåœ¨Githubä¸Šæ­å»ºåšå®¢">
                <i class="fa fa-chevron-left"></i> ä½¿ç”¨jekyllåœ¨Githubä¸Šæ­å»ºåšå®¢
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/2014/07/android-UI-Thread.html" rel="prev" title="Android UIçº¿ç¨‹å’Œå­çº¿ç¨‹ã€Serviceé€šä¿¡">
                Android UIçº¿ç¨‹å’Œå­çº¿ç¨‹ã€Serviceé€šä¿¡ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zMjI4My84ODQ3"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="EZLippi" />
          <p class="site-author-name" itemprop="name">EZLippi</p>
          <p class="site-description motion-element" itemprop="description">Easy Lippi</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">95</span>
                <span class="site-state-item-name">æ—¥å¿—</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">30</span>
                <span class="site-state-item-name">åˆ†ç±»</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">103</span>
                <span class="site-state-item-name">æ ‡ç­¾</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/EZLippi" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/ouyanglip" target="_blank" title="weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/lippi-ouyang" target="_blank" title="zhihu">
                  
                    <i class="fa fa-fw fa-battery-3"></i>
                  
                  zhihu
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              å‹æƒ…é“¾æ¥
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.woaitqs.cc/" title="Qisen Tang" target="_blank">Qisen Tang</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://szhshp.org" title="szhshpçš„åšå®¢" target="_blank">szhshpçš„åšå®¢</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://python.zhangwei.website" title="JuniorCoder" target="_blank">JuniorCoder</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://hippo-jessy.com" title="Hippo" target="_blank">Hippo</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.zhihu.com/people/lippi-ouyang" title="å‹é“¾å‡ºç§Ÿ" target="_blank">å‹é“¾å‡ºç§Ÿ</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#ä»€ä¹ˆæ˜¯UIçº¿ç¨‹ï¼Ÿ"><span class="nav-number">1.</span> <span class="nav-text">ä»€ä¹ˆæ˜¯UIçº¿ç¨‹ï¼Ÿ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¸ºä»€ä¹ˆä½ çš„App-Crashesï¼Ÿ"><span class="nav-number">2.</span> <span class="nav-text">ä¸ºä»€ä¹ˆä½ çš„App Crashesï¼Ÿ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android-AsyncTaskå®Œå…¨è§£æ"><span class="nav-number">3.</span> <span class="nav-text">Android AsyncTaskå®Œå…¨è§£æ</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">EZLippi</span>
</div>


<div class="powered-by">
  ç”± <a class="theme-link" href="https://hexo.io" rel="external nofollow">Hexo</a> å¼ºåŠ›é©±åŠ¨
</div>

<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next" rel="external nofollow">
    NexT.Mist
  </a>| Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a>
</div>





        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  
      <!-- UY BEGIN -->
      <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid="></script>
      <!-- UY END -->
  



  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  


  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("kJ2sJuSJeByLioULSXrJ5CSq-9Nh9j0Va", "uBWeNxCbFEWsOVDTmAInrDq3");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

	<!-- é¡µé¢ç‚¹å‡»å°çº¢å¿ƒ -->
<script type="text/javascript" src="/js/src/love.js"></script>

</body>
</html>
